<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Hexo</title>
  
  
  <link href="https://dragonliu2018.github.io/atom.xml" rel="self"/>
  
  <link href="https://dragonliu2018.github.io/"/>
  <updated>2025-09-25T16:31:25.463Z</updated>
  <id>https://dragonliu2018.github.io/</id>
  
  <author>
    <name>John Doe</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>[Tool] C++ benchmark</title>
    <link href="https://dragonliu2018.github.io/2025/09/26/Tool-C-benchmark/"/>
    <id>https://dragonliu2018.github.io/2025/09/26/Tool-C-benchmark/</id>
    <published>2025-09-25T16:30:37.000Z</published>
    <updated>2025-09-25T16:31:25.463Z</updated>
    
    <content type="html"><![CDATA[<h1 id="1-编译"><a class="markdownIt-Anchor" href="#1-编译"></a> 1 编译</h1><ol><li><p>clone 仓库：<code>git clone https://github.com/google/benchmark.git</code></p></li><li><p>新建 build：</p> <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> benchmark</span><br><span class="line"><span class="built_in">mkdir</span> build</span><br><span class="line"><span class="built_in">cd</span> build</span><br></pre></td></tr></table></figure></li><li><p>cmake &amp; 下载依赖:</p> <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cmake -DBENCHMARK_DOWNLOAD_DEPENDENCIES=on -DCMAKE_BUILD_TYPE=Release ../</span><br></pre></td></tr></table></figure></li><li><p>编译：</p> <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cmake --build <span class="string">&quot;build&quot;</span> --config Release</span><br></pre></td></tr></table></figure></li></ol><h1 id="2-编写测试"><a class="markdownIt-Anchor" href="#2-编写测试"></a> 2 编写测试</h1><h1 id="3-在线-benchmark"><a class="markdownIt-Anchor" href="#3-在线-benchmark"></a> 3 在线 benchmark</h1><p><a href="https://quick-bench.com/q/6tDxsmk3FMX55B8W1RrdiG_s7_k">https://quick-bench.com/q/6tDxsmk3FMX55B8W1RrdiG_s7_k</a></p><h1 id="x-参考"><a class="markdownIt-Anchor" href="#x-参考"></a> X 参考</h1>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;1-编译&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#1-编译&quot;&gt;&lt;/a&gt; 1 编译&lt;/h1&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;clone 仓库：&lt;code&gt;git clone https://github.com/google/bench</summary>
      
    
    
    
    <category term="PL" scheme="https://dragonliu2018.github.io/categories/PL/"/>
    
    <category term="Tool" scheme="https://dragonliu2018.github.io/categories/Tool/"/>
    
    <category term="C++" scheme="https://dragonliu2018.github.io/categories/PL/C/"/>
    
    <category term="调优" scheme="https://dragonliu2018.github.io/categories/Tool/%E8%B0%83%E4%BC%98/"/>
    
    
  </entry>
  
  <entry>
    <title>[Tool] gperf 安装使用教程</title>
    <link href="https://dragonliu2018.github.io/2025/09/26/Tool-gperf-%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/"/>
    <id>https://dragonliu2018.github.io/2025/09/26/Tool-gperf-%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/</id>
    <published>2025-09-25T16:28:23.000Z</published>
    <updated>2025-09-25T16:28:47.582Z</updated>
    
    <content type="html"><![CDATA[<h1 id="1-介绍"><a class="markdownIt-Anchor" href="#1-介绍"></a> 1 介绍</h1><p><a href="https://github.com/gperftools/gperftools">https://github.com/gperftools/gperftools</a></p><p><a href="https://github.com/gperftools/gperftools">gperftools</a> 是谷歌推出的一套非常强大的性能分析工具集. 它主要有这三个功能:</p><ul><li>分析 CPU 性能, 能够统计出一段时间内各个函数的执行时间, 帮助我们找出耗时的代码;</li><li>分析内存占用情况, 能够统计出某一时刻各个函数分配的内存大小, 帮助我们找出内存占用高的代码, 也能帮助我们定位内存泄露;</li><li>自动检查内存泄露.</li></ul><p>gperftools 还包含一个高性能内存分配器 tcmalloc, 我们可以用它代替 glibc 的 ptmalloc. tcmalloc 自带统计功能, 内存分析和检查内存泄露就靠它.</p><p>本文介绍 gperftools 在 Linux 下的一些常见的用法. 如果你需要使用 gperftools 分析 Linux (服务器) 程序, 这篇文章可以当作一个 Quick Start.</p><h1 id="2-安装"><a class="markdownIt-Anchor" href="#2-安装"></a> 2 安装</h1><p><strong>方法1：</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ruby -e <span class="string">&quot;<span class="subst">$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)</span>&quot;</span> &lt; /dev/null 2&gt; /dev/null</span><br></pre></td></tr></table></figure><p><strong>方法2:</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">brew install gperftools</span><br></pre></td></tr></table></figure><h1 id="3-使用"><a class="markdownIt-Anchor" href="#3-使用"></a> 3 使用</h1><h1 id="x-参考"><a class="markdownIt-Anchor" href="#x-参考"></a> X 参考</h1><ul><li><a href="https://stackoverflow.com/questions/23200704/install-perf-on-mac"><strong>Install “perf” on Mac</strong></a></li><li><a href="https://luyuhuang.tech/2022/04/10/gperftools.html"><strong>使用 gperftools 分析程序性能</strong></a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;1-介绍&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#1-介绍&quot;&gt;&lt;/a&gt; 1 介绍&lt;/h1&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/gperftools/gperftools&quot;&gt;https://github.</summary>
      
    
    
    
    <category term="Tool" scheme="https://dragonliu2018.github.io/categories/Tool/"/>
    
    <category term="调优" scheme="https://dragonliu2018.github.io/categories/Tool/%E8%B0%83%E4%BC%98/"/>
    
    
  </entry>
  
  <entry>
    <title>[Tool] perf 安装使用教程</title>
    <link href="https://dragonliu2018.github.io/2025/09/26/Tool-perf-%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/"/>
    <id>https://dragonliu2018.github.io/2025/09/26/Tool-perf-%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/</id>
    <published>2025-09-25T16:24:37.000Z</published>
    <updated>2025-09-25T16:28:35.585Z</updated>
    
    <content type="html"><![CDATA[<h1 id="1-ubuntu-安装步骤"><a class="markdownIt-Anchor" href="#1-ubuntu-安装步骤"></a> 1 ubuntu 安装步骤</h1><ol><li><p>安装<code>linux-tools-common</code>：</p> <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt-get install linux-tools-common</span><br></pre></td></tr></table></figure></li><li><p>此时运行perf仍然失败：</p> <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">➜  matrixdb git:(main) ✗ perf</span><br><span class="line">WARNING: perf not found <span class="keyword">for</span> kernel 5.15.0-69</span><br><span class="line"></span><br><span class="line">  You may need to install the following packages <span class="keyword">for</span> this specific kernel:</span><br><span class="line">    linux-tools-5.15.0-69-generic</span><br><span class="line">    linux-cloud-tools-5.15.0-69-generic</span><br><span class="line"></span><br><span class="line">  You may also want to install one of the following packages to keep up to <span class="built_in">date</span>:</span><br><span class="line">    linux-tools-generic</span><br><span class="line">    linux-cloud-tools-generic</span><br></pre></td></tr></table></figure></li><li><p>根据提示先进行对应包的更新：</p> <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt-get install linux-tools-generic linux-cloud-tools-generic</span><br></pre></td></tr></table></figure></li><li><p>下载对应包：</p> <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt-get install linux-tools-5.15.0-69-generic linux-cloud-tools-5.15.0-69-generic</span><br></pre></td></tr></table></figure></li><li><p>进行验证，下载成功：</p> <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">➜  matrixdb git:(main) ✗ perf -v</span><br><span class="line">perf version 5.15.87</span><br></pre></td></tr></table></figure></li></ol><h1 id="2-卸载"><a class="markdownIt-Anchor" href="#2-卸载"></a> 2 卸载</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt-get remove linux-tools-common linux-tools-$(<span class="built_in">uname</span> -r) linux-cloud-tools-$(<span class="built_in">uname</span> -r)</span><br></pre></td></tr></table></figure><h1 id="3-报错"><a class="markdownIt-Anchor" href="#3-报错"></a> 3 报错</h1><h2 id="31-报错1the-cpu_corecycles-event-is-not-supported"><a class="markdownIt-Anchor" href="#31-报错1the-cpu_corecycles-event-is-not-supported"></a> 3.1 报错1：The cpu_core/cycles/ event is not supported.</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">➜  build git:(p1) ✗ <span class="built_in">sudo</span> perf record ./test/buffer_pool_manager_instance_test</span><br><span class="line">Error:</span><br><span class="line">The cpu_core/cycles/ event is not supported.</span><br></pre></td></tr></table></figure><p>在公司 macbook 上没有出现报错，在实验室 win11 上出现上述问题。</p><p><strong>参考</strong> <a href="https://www.cnblogs.com/azureology/p/13913540.html">虚拟机Linux使用perf stat提示cycles not supported</a>，解决方法如下：</p><ol><li>关闭VMware虚拟机电源，找到硬件配置选项中CPU</li><li>勾选<code>☑️虚拟化CPU性能计数器</code></li><li>重启问题解决（但是我的机器勾选后无法启动虚拟机了🥦</li></ol><h1 id="4-使用"><a class="markdownIt-Anchor" href="#4-使用"></a> 4 使用</h1><h2 id="41-抓取性能信息"><a class="markdownIt-Anchor" href="#41-抓取性能信息"></a> 4.1 抓取性能信息</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 进程</span></span><br><span class="line"><span class="built_in">sudo</span> perf record --call-graph=dwarf -p 479061</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可执行文件</span></span><br><span class="line"><span class="built_in">sudo</span> perf record --call-graph=dwarf ./exec</span><br></pre></td></tr></table></figure><h2 id="42-结果展示"><a class="markdownIt-Anchor" href="#42-结果展示"></a> 4.2 结果展示</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> perf report -i perf.data --no-inline -g</span><br></pre></td></tr></table></figure><h2 id="43-快捷键"><a class="markdownIt-Anchor" href="#43-快捷键"></a> 4.3 快捷键</h2><ol><li>展开：<code>shift</code> + <code>+</code></li><li></li></ol><h1 id="x-参考"><a class="markdownIt-Anchor" href="#x-参考"></a> X 参考</h1><ul><li><a href="https://www.jianshu.com/p/4659063b3c0d"><strong>基于Ubuntu 18.04 安装perf工具</strong></a></li><li><a href="https://installati.one/install-perf-tools-unstable-ubuntu-22-04/"><strong>How To Install perf-tools-unstable on Ubuntu 22.04</strong></a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;1-ubuntu-安装步骤&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#1-ubuntu-安装步骤&quot;&gt;&lt;/a&gt; 1 ubuntu 安装步骤&lt;/h1&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;安装&lt;code&gt;linux-tools-common&lt;/c</summary>
      
    
    
    
    <category term="Tool" scheme="https://dragonliu2018.github.io/categories/Tool/"/>
    
    <category term="调优" scheme="https://dragonliu2018.github.io/categories/Tool/%E8%B0%83%E4%BC%98/"/>
    
    
  </entry>
  
  <entry>
    <title>[PL][C++] 性能优化汇总</title>
    <link href="https://dragonliu2018.github.io/2025/09/26/PL-C-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%B1%87%E6%80%BB/"/>
    <id>https://dragonliu2018.github.io/2025/09/26/PL-C-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%B1%87%E6%80%BB/</id>
    <published>2025-09-25T16:06:51.000Z</published>
    <updated>2025-09-25T16:20:12.162Z</updated>
    
    <content type="html"><![CDATA[<h1 id="常用技巧"><a class="markdownIt-Anchor" href="#常用技巧"></a> 常用技巧</h1><ul><li>避免构造不必要的对象，例如 std::string</li><li>函数返回值为常量字符串时，且需要 std::string_view 类型；函数返回值类型可以设为 std::string_view，如果设为 std::string，会有多余的拷贝。</li></ul><h1 id="分支预测-unlikely"><a class="markdownIt-Anchor" href="#分支预测-unlikely"></a> 分支预测 &amp; unlikely</h1><p>ref：<a href="https://www.zhihu.com/question/639443238">https://www.zhihu.com/question/639443238</a></p><h1 id="避免反复构造和析构-vector"><a class="markdownIt-Anchor" href="#避免反复构造和析构-vector"></a> 避免反复构造和析构 vector</h1><p>【热点】</p><p>问题来源于 YMatrix 实习，下面的 vector 声明在了 for 循环内部，每次遍历都会进行构造和析构，成本较大。</p><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (std::<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; times; ++i) &#123;</span><br><span class="line">std::vector&lt;std::<span class="type">uint32_t</span>&gt; idx_chain;</span><br><span class="line"><span class="built_in">func</span>(idx_chain);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr /><p>【优化】</p><p>可以将 vector 声明位置提到 for 循环外部，每次遍历对 vector 进行 clear 即可</p><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">std::vector&lt;std::<span class="type">uint32_t</span>&gt; idx_chain;</span><br><span class="line"><span class="keyword">for</span> (std::<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; times; ++i) &#123;</span><br><span class="line">    idx_chain.<span class="built_in">clear</span>();</span><br><span class="line">    <span class="built_in">func</span>(idx_chain);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="vector-使用-reserve-避免重复内存申请与数据复制"><a class="markdownIt-Anchor" href="#vector-使用-reserve-避免重复内存申请与数据复制"></a> vector 使用 reserve 避免重复内存申请与数据复制</h1><h2 id="场景介绍"><a class="markdownIt-Anchor" href="#场景介绍"></a> 场景介绍</h2><p><strong>当使用 vector 时，如果已知需要多少元素的空间，则使用 <code>reserve</code> 函数预先分配足够的内存空间，减少动态内存分配和元素复制的次数</strong>。这使得插入操作更加高效，尤其是在处理大量数据时，性能优势更加明显。</p><h2 id="代码验证"><a class="markdownIt-Anchor" href="#代码验证"></a> 代码验证</h2><p>【<strong>链接</strong>】<a href="https://quick-bench.com/q/ctDLCeIqzoycLX9KUuBajAapaUA">https://quick-bench.com/q/ctDLCeIqzoycLX9KUuBajAapaUA</a></p><hr /><ul><li><p><strong>代码</strong></p>  <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">int</span> SIZE = <span class="number">10000</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">vector_push_back_one_by_one</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::vector&lt;std::string&gt; str_vec;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; SIZE; i++) &#123;</span><br><span class="line">        str_vec.<span class="built_in">push_back</span>(std::<span class="built_in">to_string</span>(i));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">vector_push_back_reserve</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::vector&lt;std::string&gt; str_vec;</span><br><span class="line">    str_vec.<span class="built_in">reserve</span>(SIZE);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; SIZE; i++) &#123;</span><br><span class="line">        str_vec.<span class="built_in">push_back</span>(std::<span class="built_in">to_string</span>(i));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">PushOneByOne</span><span class="params">(benchmark::State&amp; state)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Code inside this loop is measured repeatedly</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span> _ : state) &#123;</span><br><span class="line">    <span class="keyword">auto</span> ret = <span class="built_in">vector_push_back_one_by_one</span>();</span><br><span class="line">    <span class="comment">// Make sure the variable is not optimized away by compiler</span></span><br><span class="line">    benchmark::<span class="built_in">DoNotOptimize</span>(ret);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Register the function as a benchmark</span></span><br><span class="line"><span class="built_in">BENCHMARK</span>(PushOneByOne);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">PushReserve</span><span class="params">(benchmark::State&amp; state)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Code before the loop is not measured</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span> _ : state) &#123;</span><br><span class="line">    <span class="keyword">auto</span> ret = <span class="built_in">vector_push_back_reserve</span>();</span><br><span class="line">    <span class="comment">// Make sure the variable is not optimized away by compiler</span></span><br><span class="line">    benchmark::<span class="built_in">DoNotOptimize</span>(ret);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">BENCHMARK</span>(PushReserve);</span><br></pre></td></tr></table></figure></li></ul><p><img src="https://raw.githubusercontent.com/Dragonliu2018/hexo-images-bed/main/2025/Snipaste_2025-09-26_00-16-21.png" alt="" /></p><h2 id="gpt-现象解释"><a class="markdownIt-Anchor" href="#gpt-现象解释"></a> GPT 现象解释</h2><p><code>vector_push_back_reserve</code> 函数比 <code>vector_push_back_one_by_one</code> 函数高效的原因主要在于内存分配策略的不同。</p><h3 id="vector_push_back_one_by_one-函数"><a class="markdownIt-Anchor" href="#vector_push_back_one_by_one-函数"></a> <strong><code>vector_push_back_one_by_one</code> 函数</strong></h3><ul><li><strong>动态内存分配</strong>：<code>std::vector</code> 的 <code>push_back</code> 方法会在容器容量不足时，自动分配新的内存来存储更多的元素。每次分配的内存大小通常是当前容量的两倍左右（具体策略因标准库实现而异）。例如，初始容量可能为 0，第一次调用 <code>push_back</code> 时分配一定大小的内存（如 16 个元素的空间），当插入第 17 个元素时，会重新分配内存（如 32 个元素的空间），并将原有元素复制到新的内存空间中，然后释放旧的内存空间。</li><li><strong>多次内存分配和复制</strong>：在插入大量元素时，这种动态内存分配会导致多次内存分配和复制操作。每次重新分配内存时，都需要将已有的元素复制到新的内存空间中，这会消耗大量的时间和计算资源。随着元素数量的增加，这种开销会逐渐累积，导致整体性能下降。</li></ul><h3 id="vector_push_back_reserve-函数"><a class="markdownIt-Anchor" href="#vector_push_back_reserve-函数"></a> <strong><code>vector_push_back_reserve</code> 函数</strong></h3><ul><li><strong>预先分配内存</strong>：<code>std::vector</code> 的 <code>reserve</code> 方法允许在容器创建时预先分配足够的内存来存储指定数量的元素。在 <code>vector_push_back_reserve</code> 函数中，通过调用 <code>str_vec.reserve(SIZE)</code>，预先分配了足够存储 <code>SIZE</code> 个 <code>std::string</code> 元素的内存空间。</li><li><strong>减少内存分配和复制</strong>：由于预先分配了足够的内存，后续调用 <code>push_back</code> 方法时，不需要再进行动态内存分配和元素复制操作。所有元素都可以直接插入到预先分配的内存空间中，从而避免了多次内存分配和复制的开销，显著提高了插入操作的效率。</li></ul><h3 id="性能对比"><a class="markdownIt-Anchor" href="#性能对比"></a> <strong>性能对比</strong></h3><ul><li><strong>时间复杂度</strong>：<code>vector_push_back_one_by_one</code> 的时间复杂度为 <em>O</em>(<em>n</em>log<em>n</em>)，因为每次重新分配内存时，都需要复制已有的元素，而复制操作的时间复杂度与当前元素数量成正比。相比之下，<code>vector_push_back_reserve</code> 的时间复杂度为 <em>O</em>(<em>n</em>)，因为所有元素都可以直接插入到预先分配的内存空间中，无需额外的复制操作。</li><li><strong>实际性能</strong>：在实际运行中，<code>vector_push_back_reserve</code> 函数的执行时间通常比 <code>vector_push_back_one_by_one</code> 函数短得多，尤其是在插入大量元素时。这是因为 <code>vector_push_back_one_by_one</code> 函数需要进行多次内存分配和复制操作，而 <code>vector_push_back_reserve</code> 函数只需要一次内存分配，后续的插入操作非常高效。</li></ul><h1 id="unordered_map-替换-map"><a class="markdownIt-Anchor" href="#unordered_map-替换-map"></a> unordered_map 替换 map</h1><h2 id="问题"><a class="markdownIt-Anchor" href="#问题"></a> 问题</h2><p>问题来自与 cmu 15-445 fall 2022 p1，当时在线测试HardTest_4 超时（上限是 10s，当时程序耗时 14s）。</p><h2 id="调优"><a class="markdownIt-Anchor" href="#调优"></a> 调优</h2><p>在 macbook 上跑的项目，没有 perf 分析工具，使用 macos 中的 Instruments 进行分析。</p><p>可以看到 <code>HardTest_4</code> 的主要耗时在 <code>HistoryCmpLess()</code> 函数上：</p><p><img src="https://raw.githubusercontent.com/Dragonliu2018/hexo-images-bed/main/2025/Snipaste_2025-09-26_00-19-21.png" alt="" /></p><p>耗时集中在下面三行代码，推测是 <code>history_</code> 的随机取数据导致性能低下。</p><p><img src="https://raw.githubusercontent.com/Dragonliu2018/hexo-images-bed/main/2025/Snipaste_2025-09-26_00-19-41.png" alt="" /></p><p>查看 <code>history_</code> 类型，果然是 map 类型，但是使用 unordered_map 更加高效。更换数据类型后，耗时下降到 7s，符合预期。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;常用技巧&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#常用技巧&quot;&gt;&lt;/a&gt; 常用技巧&lt;/h1&gt;
&lt;ul&gt;
&lt;li&gt;避免构造不必要的对象，例如 std::string&lt;/li&gt;
&lt;li&gt;函数返回值为常量字符串时，且需要 std::str</summary>
      
    
    
    
    <category term="PL" scheme="https://dragonliu2018.github.io/categories/PL/"/>
    
    <category term="C++" scheme="https://dragonliu2018.github.io/categories/PL/C/"/>
    
    
  </entry>
  
  <entry>
    <title>[Tool] docker 使用技巧汇总</title>
    <link href="https://dragonliu2018.github.io/2025/09/25/Tool-docker-%E4%BD%BF%E7%94%A8%E6%8A%80%E5%B7%A7%E6%B1%87%E6%80%BB/"/>
    <id>https://dragonliu2018.github.io/2025/09/25/Tool-docker-%E4%BD%BF%E7%94%A8%E6%8A%80%E5%B7%A7%E6%B1%87%E6%80%BB/</id>
    <published>2025-09-25T11:56:32.000Z</published>
    <updated>2025-09-25T16:01:36.310Z</updated>
    
    <content type="html"><![CDATA[<h1 id="导出导入镜像"><a class="markdownIt-Anchor" href="#导出导入镜像"></a> 导出导入镜像</h1><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">导出镜像</span></span><br><span class="line">docker save -o doris.tar apache/doris:build-env-ldb-toolchain-latest</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">导入镜像</span></span><br><span class="line">docker load -i doris.tar</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;导出导入镜像&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#导出导入镜像&quot;&gt;&lt;/a&gt; 导出导入镜像&lt;/h1&gt;
&lt;figure class=&quot;highlight shell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&lt;pr</summary>
      
    
    
    
    <category term="Tool" scheme="https://dragonliu2018.github.io/categories/Tool/"/>
    
    <category term="docker" scheme="https://dragonliu2018.github.io/categories/Tool/docker/"/>
    
    
  </entry>
  
  <entry>
    <title>[PL][Python] 编程技巧汇总</title>
    <link href="https://dragonliu2018.github.io/2025/09/24/PL-Python-%E7%BC%96%E7%A8%8B%E6%8A%80%E5%B7%A7%E6%B1%87%E6%80%BB/"/>
    <id>https://dragonliu2018.github.io/2025/09/24/PL-Python-%E7%BC%96%E7%A8%8B%E6%8A%80%E5%B7%A7%E6%B1%87%E6%80%BB/</id>
    <published>2025-09-24T15:47:34.000Z</published>
    <updated>2025-09-24T15:48:11.695Z</updated>
    
    
    
    
    <category term="PL" scheme="https://dragonliu2018.github.io/categories/PL/"/>
    
    <category term="Python" scheme="https://dragonliu2018.github.io/categories/PL/Python/"/>
    
    
  </entry>
  
  <entry>
    <title>[PL][Python] 常见 bug 汇总</title>
    <link href="https://dragonliu2018.github.io/2025/09/24/PL-Python-%E5%B8%B8%E8%A7%81-bug-%E6%B1%87%E6%80%BB/"/>
    <id>https://dragonliu2018.github.io/2025/09/24/PL-Python-%E5%B8%B8%E8%A7%81-bug-%E6%B1%87%E6%80%BB/</id>
    <published>2025-09-24T15:47:16.000Z</published>
    <updated>2025-09-24T15:51:51.209Z</updated>
    
    <content type="html"><![CDATA[<h1 id="sort-sorted"><a class="markdownIt-Anchor" href="#sort-sorted"></a> sort() &amp; sorted()</h1><p>对比两个列表是否含有相同的元素，不需要顺序一样。sort() 函数返回 None，因此不能直接使用 method-1 进行判断。</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># method-1 error</span></span><br><span class="line"><span class="keyword">if</span> l1.sort() == l2.sort():</span><br><span class="line">  xxx</span><br><span class="line"></span><br><span class="line"><span class="comment"># method-2 OK</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">sorted</span>(l1) == <span class="built_in">sorted</span>(l2):</span><br><span class="line">  xxx</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;sort-sorted&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#sort-sorted&quot;&gt;&lt;/a&gt; sort() &amp;amp; sorted()&lt;/h1&gt;
&lt;p&gt;对比两个列表是否含有相同的元素，不需要顺序一样。sort() 函数返回</summary>
      
    
    
    
    <category term="PL" scheme="https://dragonliu2018.github.io/categories/PL/"/>
    
    <category term="Python" scheme="https://dragonliu2018.github.io/categories/PL/Python/"/>
    
    
  </entry>
  
  <entry>
    <title>[Tool] github 使用技巧汇总</title>
    <link href="https://dragonliu2018.github.io/2025/09/24/Tool-github-%E4%BD%BF%E7%94%A8%E6%8A%80%E5%B7%A7%E6%B1%87%E6%80%BB/"/>
    <id>https://dragonliu2018.github.io/2025/09/24/Tool-github-%E4%BD%BF%E7%94%A8%E6%8A%80%E5%B7%A7%E6%B1%87%E6%80%BB/</id>
    <published>2025-09-24T14:45:16.000Z</published>
    <updated>2025-09-24T15:43:04.789Z</updated>
    
    <content type="html"><![CDATA[<h1 id="新增-ssh-密钥到-github-帐户"><a class="markdownIt-Anchor" href="#新增-ssh-密钥到-github-帐户"></a> 新增 SSH 密钥到 GitHub 帐户</h1><ol><li><p>生成 key，一路默认即可：</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">➜  .ssh ssh-keygen</span><br></pre></td></tr></table></figure></li><li><p>复制 id_rsa.pub 文件中的内容到 GitHub：</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">➜  .ssh cat id_rsa.pub</span><br></pre></td></tr></table></figure></li><li><p>测试是否配置成功：</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">➜  .ssh ssh -T git@github.com</span><br><span class="line">Hi Dragonliu2018! You&#x27;ve successfully authenticated, but GitHub does not provide shell access.</span><br></pre></td></tr></table></figure></li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;新增-ssh-密钥到-github-帐户&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#新增-ssh-密钥到-github-帐户&quot;&gt;&lt;/a&gt; 新增 SSH 密钥到 GitHub 帐户&lt;/h1&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;生成 key，一</summary>
      
    
    
    
    <category term="Tool" scheme="https://dragonliu2018.github.io/categories/Tool/"/>
    
    <category term="git" scheme="https://dragonliu2018.github.io/categories/Tool/git/"/>
    
    
  </entry>
  
  <entry>
    <title>[Tool] git 报错汇总</title>
    <link href="https://dragonliu2018.github.io/2025/09/24/Tool-git-%E6%8A%A5%E9%94%99%E6%B1%87%E6%80%BB/"/>
    <id>https://dragonliu2018.github.io/2025/09/24/Tool-git-%E6%8A%A5%E9%94%99%E6%B1%87%E6%80%BB/</id>
    <published>2025-09-24T14:44:11.000Z</published>
    <updated>2025-09-24T15:43:06.611Z</updated>
    
    <content type="html"><![CDATA[<h1 id=""><a class="markdownIt-Anchor" href="#"></a> </h1>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#&quot;&gt;&lt;/a&gt; &lt;/h1&gt;
</summary>
      
    
    
    
    <category term="Tool" scheme="https://dragonliu2018.github.io/categories/Tool/"/>
    
    <category term="git" scheme="https://dragonliu2018.github.io/categories/Tool/git/"/>
    
    
  </entry>
  
  <entry>
    <title>[Tool] git 使用技巧汇总</title>
    <link href="https://dragonliu2018.github.io/2025/09/24/Tool-git-%E4%BD%BF%E7%94%A8%E6%8A%80%E5%B7%A7%E6%B1%87%E6%80%BB/"/>
    <id>https://dragonliu2018.github.io/2025/09/24/Tool-git-%E4%BD%BF%E7%94%A8%E6%8A%80%E5%B7%A7%E6%B1%87%E6%80%BB/</id>
    <published>2025-09-24T14:21:50.000Z</published>
    <updated>2025-09-25T16:01:36.310Z</updated>
    
    <content type="html"><![CDATA[<h1 id="将当前修改压到-head-commit"><a class="markdownIt-Anchor" href="#将当前修改压到-head-commit"></a> 将当前修改压到 HEAD commit</h1><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">git commit --amend</span><br></pre></td></tr></table></figure><h1 id="取消某个文件的更改"><a class="markdownIt-Anchor" href="#取消某个文件的更改"></a> 取消某个文件的更改</h1><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">git checkout -- &lt;file_name&gt;</span><br></pre></td></tr></table></figure><blockquote><p>参考：<a href="https://blog.csdn.net/qq_32907195/article/details/115333898">https://blog.csdn.net/qq_32907195/article/details/115333898</a></p></blockquote><h1 id="删除某个文件夹"><a class="markdownIt-Anchor" href="#删除某个文件夹"></a> 删除某个文件(夹)</h1><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">推荐</span></span><br><span class="line">git rm &lt;file_name&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">相当于</span></span><br><span class="line">rm &lt;file_name&gt;</span><br><span class="line">git add &lt;file_name&gt;</span><br></pre></td></tr></table></figure><h1 id="ignore-已经-push-到远端的文件"><a class="markdownIt-Anchor" href="#ignore-已经-push-到远端的文件"></a> ignore 已经 push 到远端的文件</h1><p>【<strong>问题</strong>】</p><p>.vscode 文件夹已经 push 到远程，如何 ignore？</p><hr /><p>【<strong>解决</strong>】</p><ol><li><p>从 Git 索引中移除 .vscode 目录（不会删除本地文件夹，只是让 git 不再跟踪它）：</p> <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">➜  SG-DQA git:(main) git <span class="built_in">rm</span> -r --cached .vscode</span><br><span class="line"><span class="built_in">rm</span> <span class="string">&#x27;.vscode/launch.json&#x27;</span></span><br><span class="line"><span class="built_in">rm</span> <span class="string">&#x27;.vscode/settings.json&#x27;</span></span><br></pre></td></tr></table></figure></li><li><p>添加 <code>.gitignore</code> 文件</p> <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">.vscode/</span><br></pre></td></tr></table></figure></li><li><p>git add &amp; git commit &amp; git push</p></li></ol><h1 id="合并多个-commit"><a class="markdownIt-Anchor" href="#合并多个-commit"></a> 合并多个 commit</h1><p><img src="https://raw.githubusercontent.com/Dragonliu2018/hexo-images-bed/main/2025/Snipaste_2025-09-24_23-13-21.png" alt="" /></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">method-1</span></span><br><span class="line">git rebase -i origin/main</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">method-2</span></span><br><span class="line">git rebase -i ce75153a87</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">method-3: 与要合并的commit数量一致</span></span><br><span class="line">git rebase -i HEAD~8</span><br></pre></td></tr></table></figure><h1 id="patch"><a class="markdownIt-Anchor" href="#patch"></a> patch</h1><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">git diff &gt; xx.patch</span><br><span class="line">git apply x.patch</span><br></pre></td></tr></table></figure><h1 id="本地分支-远程分支"><a class="markdownIt-Anchor" href="#本地分支-远程分支"></a> 本地分支 &amp; 远程分支</h1><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看本地分支关联（跟踪）的远程分支之间的对应关系</span></span><br><span class="line">git branch -vv</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">推送当前分支到远程（没有对应分支）</span></span><br><span class="line">git push -f --set-upstream origin dragonliu/dictionary_mysql_opt</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置本地分支与远程分支的关联</span></span><br><span class="line">git branch --set-upstream-to=origin/&lt;远程分支名&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="删除分支"><a class="markdownIt-Anchor" href="#删除分支"></a> 删除分支</h1><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除本地分支</span></span><br><span class="line">git branch -D fix/authentication</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除远程分支</span></span><br><span class="line"> git push origin --delete fix/authentication</span><br></pre></td></tr></table></figure><h1 id="撤销-commit"><a class="markdownIt-Anchor" href="#撤销-commit"></a> 撤销 commit</h1><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">撤销本地 commit</span></span><br><span class="line">git reset --soft HEAD^</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">撤销远程 commit</span></span><br><span class="line">git reset HEAD^</span><br><span class="line">git push -f</span><br></pre></td></tr></table></figure><h1 id="修改远程仓库链接"><a class="markdownIt-Anchor" href="#修改远程仓库链接"></a> 修改远程仓库链接</h1><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">git remote set-url origin git@github.com:Dragonliu2018/doris.git</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;将当前修改压到-head-commit&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#将当前修改压到-head-commit&quot;&gt;&lt;/a&gt; 将当前修改压到 HEAD commit&lt;/h1&gt;
&lt;figure class=&quot;highlight</summary>
      
    
    
    
    <category term="Tool" scheme="https://dragonliu2018.github.io/categories/Tool/"/>
    
    <category term="git" scheme="https://dragonliu2018.github.io/categories/Tool/git/"/>
    
    
  </entry>
  
  <entry>
    <title>[Tool] wsl 报错汇总</title>
    <link href="https://dragonliu2018.github.io/2025/09/24/Tool-wsl-%E6%8A%A5%E9%94%99%E6%B1%87%E6%80%BB/"/>
    <id>https://dragonliu2018.github.io/2025/09/24/Tool-wsl-%E6%8A%A5%E9%94%99%E6%B1%87%E6%80%BB/</id>
    <published>2025-09-24T14:08:37.000Z</published>
    <updated>2025-09-24T14:12:11.127Z</updated>
    
    <content type="html"><![CDATA[<h1 id="执行-systemctl-失败"><a class="markdownIt-Anchor" href="#执行-systemctl-失败"></a> 执行 systemctl 失败</h1><p>【<strong>问题</strong>】</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">System has not been booted with systemd as init system (PID 1). Can&#x27;t operate. Failed to connect to bus: Host is down</span><br></pre></td></tr></table></figure><hr /><p>【<strong>解决</strong>】</p><p><a href="https://github.com/microsoft/WSL/issues/8883">https://github.com/microsoft/WSL/issues/8883</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;执行-systemctl-失败&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#执行-systemctl-失败&quot;&gt;&lt;/a&gt; 执行 systemctl 失败&lt;/h1&gt;
&lt;p&gt;【&lt;strong&gt;问题&lt;/strong&gt;】&lt;/p&gt;
&lt;figure</summary>
      
    
    
    
    <category term="Tool" scheme="https://dragonliu2018.github.io/categories/Tool/"/>
    
    <category term="wsl" scheme="https://dragonliu2018.github.io/categories/Tool/wsl/"/>
    
    
  </entry>
  
  <entry>
    <title>[databend] pivot 支持 subquery</title>
    <link href="https://dragonliu2018.github.io/2025/09/14/databend-pivot-%E6%94%AF%E6%8C%81-subquery/"/>
    <id>https://dragonliu2018.github.io/2025/09/14/databend-pivot-%E6%94%AF%E6%8C%81-subquery/</id>
    <published>2025-09-14T09:45:42.000Z</published>
    <updated>2025-09-23T01:06:58.364Z</updated>
    
    <content type="html"><![CDATA[<h1 id="1-任务背景"><a class="markdownIt-Anchor" href="#1-任务背景"></a> 1 任务背景</h1><ul><li><strong>Issue</strong>：<a href="https://github.com/databendlabs/databend/issues/16556">https://github.com/databendlabs/databend/issues/16556</a></li><li><strong>PR</strong>：<a href="https://github.com/databendlabs/databend/pull/16631">https://github.com/databendlabs/databend/pull/16631</a></li></ul><h2 id="11-任务介绍"><a class="markdownIt-Anchor" href="#11-任务介绍"></a> 1.1 任务介绍</h2><p><strong>目前 databend 中的 pivot 和 unpivot 不支持 <code>FROM/IN + subquery</code></strong>。→ <a href="https://docs.databend.com/sql/sql-commands/query-syntax/query-pivot">文档链接</a></p><p><strong>要求实现类似于 snowflake 的语法，也就是让 pivot 支持 <code>FROM/IN + subquery</code>，unpivot 支持 <code>FROM + subquery</code></strong>。→ <a href="https://docs.snowflake.com/en/sql-reference/constructs/pivot">文档链接</a></p><ul><li><p><strong>databend PIVOT 语法</strong></p>  <figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> ...</span><br><span class="line"><span class="keyword">FROM</span> ...</span><br><span class="line">   PIVOT ( <span class="operator">&lt;</span>aggregate_function<span class="operator">&gt;</span> ( <span class="operator">&lt;</span>pivot_column<span class="operator">&gt;</span> )</span><br><span class="line">            <span class="keyword">FOR</span> <span class="operator">&lt;</span>value_column<span class="operator">&gt;</span> <span class="keyword">IN</span> ( <span class="operator">&lt;</span>pivot_value_1<span class="operator">&gt;</span> [ , <span class="operator">&lt;</span>pivot_value_2<span class="operator">&gt;</span> ... ] ) )</span><br><span class="line"></span><br><span class="line">[ ... ]</span><br></pre></td></tr></table></figure><ul><li><code>&lt;aggregate_function&gt;</code>：用于组合来自<code>pivot_column</code>的分组值的聚合函数。</li><li><code>&lt;pivot_column&gt;</code>：将使用指定的<code>&lt;aggregate_function&gt;</code>进行聚合的列。</li><li><code>&lt;value_column&gt;</code>：其唯一值将在旋转结果集中成为新列的列。</li><li><code>&lt;pivot_value_N&gt;</code>：来自<code>&lt;value_column&gt;</code>的唯一值，将在旋转结果集中成为新列。</li></ul></li><li><p><strong>databend UNPIVOT 语法</strong></p>  <figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> ...</span><br><span class="line"><span class="keyword">FROM</span> ...</span><br><span class="line">    UNPIVOT ( <span class="operator">&lt;</span>value_column<span class="operator">&gt;</span></span><br><span class="line">    <span class="keyword">FOR</span> <span class="operator">&lt;</span>name_column<span class="operator">&gt;</span> <span class="keyword">IN</span> ( <span class="operator">&lt;</span>column_list<span class="operator">&gt;</span> ) )</span><br><span class="line"></span><br><span class="line">[ ... ]</span><br></pre></td></tr></table></figure><ul><li><code>&lt;value_column&gt;</code>：将存储从 <code>&lt;column_list&gt;</code> 中列出的列中提取的值的列。</li><li><code>&lt;name_column&gt;</code>：将存储从中提取值的列的名称的列。</li><li><code>&lt;column_list&gt;</code>：要取消透视的列的列表，用逗号分隔。</li></ul></li><li><p><strong>snowflake PIVOT 语法</strong></p>  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> ...</span><br><span class="line"><span class="keyword">FROM</span> ...</span><br><span class="line">   PIVOT ( <span class="operator">&lt;</span>aggregate_function<span class="operator">&gt;</span> ( <span class="operator">&lt;</span>pivot_column<span class="operator">&gt;</span> )</span><br><span class="line">            <span class="keyword">FOR</span> <span class="operator">&lt;</span>value_column<span class="operator">&gt;</span> <span class="keyword">IN</span> (</span><br><span class="line">              <span class="operator">&lt;</span>pivot_value_1<span class="operator">&gt;</span> [ , <span class="operator">&lt;</span>pivot_value_2<span class="operator">&gt;</span> ... ]</span><br><span class="line">              <span class="operator">|</span> <span class="keyword">ANY</span> [ <span class="keyword">ORDER</span> <span class="keyword">BY</span> ... ]</span><br><span class="line">              <span class="operator">|</span> <span class="operator">&lt;</span>subquery<span class="operator">&gt;</span></span><br><span class="line">            )</span><br><span class="line">            [ <span class="keyword">DEFAULT</span> <span class="keyword">ON</span> <span class="keyword">NULL</span> (<span class="operator">&lt;</span><span class="keyword">value</span><span class="operator">&gt;</span>) ]</span><br><span class="line">         )</span><br><span class="line"></span><br><span class="line">[ ... ]</span><br></pre></td></tr></table></figure></li><li><p><strong>snowflake UNPIVOT 语法</strong></p>  <figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> ...</span><br><span class="line"><span class="keyword">FROM</span> ...</span><br><span class="line">    UNPIVOT [ &#123; INCLUDE <span class="operator">|</span> EXCLUDE &#125; NULLS ]</span><br><span class="line">      ( <span class="operator">&lt;</span>value_column<span class="operator">&gt;</span></span><br><span class="line">        <span class="keyword">FOR</span> <span class="operator">&lt;</span>name_column<span class="operator">&gt;</span> <span class="keyword">IN</span> ( <span class="operator">&lt;</span>column_list<span class="operator">&gt;</span> ) )</span><br><span class="line"></span><br><span class="line">[ ... ]</span><br></pre></td></tr></table></figure></li></ul><h2 id="12-介绍-pivot-unpivot"><a class="markdownIt-Anchor" href="#12-介绍-pivot-unpivot"></a> 1.2 介绍 pivot &amp; unpivot</h2><h3 id="121-pivot透视一列中的属性值转成多个对应属性"><a class="markdownIt-Anchor" href="#121-pivot透视一列中的属性值转成多个对应属性"></a> 1.2.1 <strong>pivot（透视，一列中的属性值转成多个对应属性）</strong></h3><blockquote><p><a href="https://docs.databend.com/sql/sql-commands/query-syntax/query-pivot">https://docs.databend.com/sql/sql-commands/query-syntax/query-pivot</a></p></blockquote><hr /><p><strong><code>PIVOT</code>操作通过旋转表格并基于指定列聚合结果来转换表格</strong>，这是一个对于总结和分析大量数据以更可读格式显示非常有用的操作。</p><hr /><ul><li><p><strong>databend PIVOT 语法</strong></p>  <figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> ...</span><br><span class="line"><span class="keyword">FROM</span> ...</span><br><span class="line">   PIVOT ( <span class="operator">&lt;</span>aggregate_function<span class="operator">&gt;</span> ( <span class="operator">&lt;</span>pivot_column<span class="operator">&gt;</span> )</span><br><span class="line">            <span class="keyword">FOR</span> <span class="operator">&lt;</span>value_column<span class="operator">&gt;</span> <span class="keyword">IN</span> ( <span class="operator">&lt;</span>pivot_value_1<span class="operator">&gt;</span> [ , <span class="operator">&lt;</span>pivot_value_2<span class="operator">&gt;</span> ... ] ) )</span><br><span class="line"></span><br><span class="line">[ ... ]</span><br></pre></td></tr></table></figure><ul><li><code>&lt;aggregate_function&gt;</code>：用于组合来自<code>pivot_column</code>的分组值的聚合函数。</li><li><code>&lt;pivot_column&gt;</code>：将使用指定的<code>&lt;aggregate_function&gt;</code>进行聚合的列。</li><li><code>&lt;value_column&gt;</code>：其唯一值将在旋转结果集中成为新列的列。</li><li><code>&lt;pivot_value_N&gt;</code>：来自<code>&lt;value_column&gt;</code>的唯一值，将在旋转结果集中成为新列。</li></ul></li></ul><hr /><p>假设我们有一个名为 monthly_sales 的表，其中<strong>包含不同员工在不同月份的销售数据</strong>。我们<strong>可以使用<code>PIVOT</code>操作来总结数据并计算每个员工在每个月的总销售额</strong>。</p><ul><li><p><strong>创建和插入数据</strong></p>  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建monthly_sales表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> monthly_sales(</span><br><span class="line">  empid <span class="type">INT</span>,</span><br><span class="line">  amount <span class="type">INT</span>,</span><br><span class="line">  <span class="keyword">month</span> <span class="type">VARCHAR</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入销售数据</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> monthly_sales <span class="keyword">VALUES</span></span><br><span class="line">  (<span class="number">1</span>, <span class="number">10000</span>, <span class="string">&#x27;JAN&#x27;</span>),</span><br><span class="line">  (<span class="number">1</span>, <span class="number">400</span>, <span class="string">&#x27;JAN&#x27;</span>),</span><br><span class="line">  (<span class="number">2</span>, <span class="number">4500</span>, <span class="string">&#x27;JAN&#x27;</span>),</span><br><span class="line">  (<span class="number">2</span>, <span class="number">35000</span>, <span class="string">&#x27;JAN&#x27;</span>),</span><br><span class="line">  (<span class="number">1</span>, <span class="number">5000</span>, <span class="string">&#x27;FEB&#x27;</span>),</span><br><span class="line">  (<span class="number">1</span>, <span class="number">3000</span>, <span class="string">&#x27;FEB&#x27;</span>),</span><br><span class="line">  (<span class="number">2</span>, <span class="number">200</span>, <span class="string">&#x27;FEB&#x27;</span>),</span><br><span class="line">  (<span class="number">2</span>, <span class="number">90500</span>, <span class="string">&#x27;FEB&#x27;</span>),</span><br><span class="line">  (<span class="number">1</span>, <span class="number">6000</span>, <span class="string">&#x27;MAR&#x27;</span>),</span><br><span class="line">  (<span class="number">1</span>, <span class="number">5000</span>, <span class="string">&#x27;MAR&#x27;</span>),</span><br><span class="line">  (<span class="number">2</span>, <span class="number">2500</span>, <span class="string">&#x27;MAR&#x27;</span>),</span><br><span class="line">  (<span class="number">2</span>, <span class="number">9500</span>, <span class="string">&#x27;MAR&#x27;</span>),</span><br><span class="line">  (<span class="number">1</span>, <span class="number">8000</span>, <span class="string">&#x27;APR&#x27;</span>),</span><br><span class="line">  (<span class="number">1</span>, <span class="number">10000</span>, <span class="string">&#x27;APR&#x27;</span>),</span><br><span class="line">  (<span class="number">2</span>, <span class="number">800</span>, <span class="string">&#x27;APR&#x27;</span>),</span><br><span class="line">  (<span class="number">2</span>, <span class="number">4500</span>, <span class="string">&#x27;APR&#x27;</span>);</span><br></pre></td></tr></table></figure></li><li><p><strong>使用 PIVOT</strong></p><p>现在，我们可以使用<code>PIVOT</code>操作来计算每个员工在每个月的总销售额。我们将使用<code>SUM</code>聚合函数来计算总销售额，<strong>MONTH 列将被旋转以为每个月创建新列。</strong></p>  <figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> monthly_sales</span><br><span class="line">PIVOT(<span class="built_in">SUM</span>(amount) <span class="keyword">FOR</span> <span class="keyword">MONTH</span> <span class="keyword">IN</span> (<span class="string">&#x27;JAN&#x27;</span>, <span class="string">&#x27;FEB&#x27;</span>, <span class="string">&#x27;MAR&#x27;</span>, <span class="string">&#x27;APR&#x27;</span>))</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> EMPID;</span><br></pre></td></tr></table></figure><p>输出：</p>  <figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="operator">+</span><span class="comment">-------+-------+-------+-------+-------+</span></span><br><span class="line"><span class="operator">|</span> empid <span class="operator">|</span> jan   <span class="operator">|</span> feb   <span class="operator">|</span> mar   <span class="operator">|</span> apr   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+-------+-------+-------+-------+</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">1</span> <span class="operator">|</span> <span class="number">10400</span> <span class="operator">|</span>  <span class="number">8000</span> <span class="operator">|</span> <span class="number">11000</span> <span class="operator">|</span> <span class="number">18000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">2</span> <span class="operator">|</span> <span class="number">39500</span> <span class="operator">|</span> <span class="number">90700</span> <span class="operator">|</span> <span class="number">12000</span> <span class="operator">|</span>  <span class="number">5300</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+-------+-------+-------+-------+</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="122-unpivot取消透视多个属性转成一列中对应的属性值"><a class="markdownIt-Anchor" href="#122-unpivot取消透视多个属性转成一列中对应的属性值"></a> 1.2.2 <strong>unpivot（取消透视，多个属性转成一列中对应的属性值）</strong></h3><blockquote><p><a href="https://docs.databend.com/sql/sql-commands/query-syntax/query-unpivot">https://docs.databend.com/sql/sql-commands/query-syntax/query-unpivot</a></p></blockquote><hr /><p><code>UNPIVOT</code> 操作通过将列转换为行来旋转表。它是一个关系操作符，接受两列（来自表或子查询），以及列的列表，并为列表中指定的每列生成一行。在查询中，它在 FROM 子句中指定，位于表名或子查询之后。</p><hr /><ul><li><p><strong>databend UNPIVOT 语法</strong></p>  <figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> ...</span><br><span class="line"><span class="keyword">FROM</span> ...</span><br><span class="line">    UNPIVOT ( <span class="operator">&lt;</span>value_column<span class="operator">&gt;</span></span><br><span class="line">    <span class="keyword">FOR</span> <span class="operator">&lt;</span>name_column<span class="operator">&gt;</span> <span class="keyword">IN</span> ( <span class="operator">&lt;</span>column_list<span class="operator">&gt;</span> ) )</span><br><span class="line"></span><br><span class="line">[ ... ]</span><br></pre></td></tr></table></figure><ul><li><code>&lt;value_column&gt;</code>：将存储从 <code>&lt;column_list&gt;</code> 中列出的列中提取的值的列。</li><li><code>&lt;name_column&gt;</code>：将存储从中提取值的列的名称的列。</li><li><code>&lt;column_list&gt;</code>：要取消透视的列的列表，用逗号分隔。</li></ul></li></ul><hr /><p>让我们取消透视个别月份列，以返回每位员工每月的单一销售值：</p><ul><li><p><strong>创建和插入数据</strong></p>  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建 unpivoted_monthly_sales 表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> unpivoted_monthly_sales(</span><br><span class="line">  empid <span class="type">INT</span>,</span><br><span class="line">  jan <span class="type">INT</span>,</span><br><span class="line">  feb <span class="type">INT</span>,</span><br><span class="line">  mar <span class="type">INT</span>,</span><br><span class="line">  apr <span class="type">INT</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入销售数据</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> unpivoted_monthly_sales <span class="keyword">VALUES</span></span><br><span class="line">  (<span class="number">1</span>, <span class="number">10400</span>,  <span class="number">8000</span>, <span class="number">11000</span>, <span class="number">18000</span>),</span><br><span class="line">  (<span class="number">2</span>, <span class="number">39500</span>, <span class="number">90700</span>, <span class="number">12000</span>,  <span class="number">5300</span>);</span><br></pre></td></tr></table></figure></li><li><p><strong>使用 UNPIVOT</strong></p>  <figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> unpivoted_monthly_sales</span><br><span class="line">    UNPIVOT (amount</span><br><span class="line">    <span class="keyword">FOR</span> <span class="keyword">month</span> <span class="keyword">IN</span> (jan, feb, mar, apr));</span><br></pre></td></tr></table></figure><p>输出：</p>  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">+</span><span class="comment">-------+-------+--------+</span></span><br><span class="line"><span class="operator">|</span> empid <span class="operator">|</span> <span class="keyword">month</span> <span class="operator">|</span> amount <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+-------+--------+</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">1</span> <span class="operator">|</span> jan   <span class="operator">|</span>  <span class="number">10400</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">1</span> <span class="operator">|</span> feb   <span class="operator">|</span>   <span class="number">8000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">1</span> <span class="operator">|</span> mar   <span class="operator">|</span>  <span class="number">11000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">1</span> <span class="operator">|</span> apr   <span class="operator">|</span>  <span class="number">18000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">2</span> <span class="operator">|</span> jan   <span class="operator">|</span>  <span class="number">39500</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">2</span> <span class="operator">|</span> feb   <span class="operator">|</span>  <span class="number">90700</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">2</span> <span class="operator">|</span> mar   <span class="operator">|</span>  <span class="number">12000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">2</span> <span class="operator">|</span> apr   <span class="operator">|</span>   <span class="number">5300</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+-------+--------+</span></span><br></pre></td></tr></table></figure></li></ul><h1 id="2-设计参考竞品分析"><a class="markdownIt-Anchor" href="#2-设计参考竞品分析"></a> 2 设计参考（竞品分析）</h1><h1 id="3-思路与实现"><a class="markdownIt-Anchor" href="#3-思路与实现"></a> 3 思路与实现</h1><h2 id="31-思路"><a class="markdownIt-Anchor" href="#31-思路"></a> 3.1 思路</h2><p>实现 <code>from + subquery</code> 较为简单，在 TableReference::Subquery 加上 pivot 和 unpivot 字段，修改 parser 及其他相关地方。</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">subquery</span> = <span class="title function_ invoke__">map</span>(</span><br><span class="line">    rule! &#123;</span><br><span class="line">        LATERAL? ~ <span class="string">&quot;(&quot;</span> ~ #query ~ <span class="string">&quot;)&quot;</span> ~ #table_alias? ~ #pivot? ~ #unpivot?</span><br><span class="line">    &#125;,</span><br><span class="line">    |(lateral, _, subquery, _, alias, pivot, unpivot)| TableReferenceElement::Subquery &#123;</span><br><span class="line">        lateral: lateral.<span class="title function_ invoke__">is_some</span>(),</span><br><span class="line">        subquery: <span class="type">Box</span>::<span class="title function_ invoke__">new</span>(subquery),</span><br><span class="line">        alias,</span><br><span class="line">        pivot: pivot.<span class="title function_ invoke__">map</span>(<span class="type">Box</span>::new),</span><br><span class="line">        unpivot: unpivot.<span class="title function_ invoke__">map</span>(<span class="type">Box</span>::new),</span><br><span class="line">    &#125;,</span><br><span class="line">);</span><br></pre></td></tr></table></figure><hr /><p>实现 <code>in + subquery</code> 相对复杂，因为在 binder 的时候必须知道 column 的 name 才能生成逻辑计划，所以只能先执行一下这个 subquery ，然后把返回值当作 values 处理；但是执行 query/plan 是在 service 模块下，binder 是在 sql 模块，存在循环调用的问题。→ <a href="https://www.notion.so/125e3d1c52c6806ca52dedaa716ef5ae?pvs=21">解决循环依赖问题</a></p><p>解决思路有三种：</p><ol><li>【<strong>思路-1</strong>】在 pivot_rewrite 阶段（binder）执行 Subquery 得到答案，参考 QuerySampleExecutor 写个回调函数在 binder 里面调一下 service 的函数执行。<ol><li><p>Pivot 结构体新添 Subquery 字段（Query），用于存储 <code>in + subquery</code> 中的 subquery；</p><ul><li><p><strong>Pivot</strong></p>  <figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 原版</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Pivot</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> aggregate: Expr,</span><br><span class="line">    <span class="keyword">pub</span> value_column: Identifier,</span><br><span class="line">    <span class="keyword">pub</span> values: <span class="type">Vec</span>&lt;Expr&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 修改后</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">enum</span> <span class="title class_">PivotValues</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">ColumnValues</span>(<span class="type">Vec</span>&lt;Expr&gt;),</span><br><span class="line">    <span class="title function_ invoke__">Subquery</span>(<span class="type">Box</span>&lt;Query&gt;),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Pivot</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> aggregate: Expr,</span><br><span class="line">    <span class="keyword">pub</span> value_column: Identifier,</span><br><span class="line">    <span class="keyword">pub</span> values: PivotValues,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul></li><li><p>在 rewrite_pivot 函数中对 Subquery 进行 parser + rewrite + opt + exec 等操作，并将结果存在原来的 <code>values</code> 字段，后续操作一致。</p><ol><li>执行 query 的回调函数目前有基于 PhysicalPlan 的，一种方案是基于该函数进行操作；另一种方案是新添基于 Query String 执行的回调函数。</li></ol></li></ol></li><li>【<strong>思路-2</strong>】在发现 subquery 的时候返回，在 service 里面执行之后重写 sql，然后再次执行。</li><li>【<strong>思路-3</strong>】现在的 plan_sql 函数里面会执行 parser 并生成 plan，可以把这个函数拆成两个：<ol><li>第一个函数执行 parser，生成 stmt，同时进行一些 rewrite，如果这时发现有 subquery 的话，就先执行一下，然后 rewrite。</li><li>第二个函数传入 rewrite 之后的 stmt，生成 plan。</li></ol></li></ol><p>本着尽可能少的改动当前代码结构的原则，选择**【思路-1】**进行实现。</p><h2 id="32-review-相关修改"><a class="markdownIt-Anchor" href="#32-review-相关修改"></a> 3.2 review 相关修改</h2><ul><li><p>【<strong>review-1</strong>】避免不必要的 clone</p>  <figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 原版</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">value</span> = columns[<span class="number">0</span>].<span class="title function_ invoke__">to_column</span>(block.<span class="title function_ invoke__">num_rows</span>());</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 修改</span></span><br><span class="line"><span class="keyword">for</span> <span class="variable">row</span> <span class="keyword">in</span> <span class="number">0</span>..block.<span class="title function_ invoke__">num_rows</span>() &#123;</span><br><span class="line">    <span class="keyword">match</span> columns[<span class="number">0</span>].value.<span class="title function_ invoke__">index</span>(row).<span class="title function_ invoke__">unwrap</span>() &#123;</span><br><span class="line">        ScalarRef::<span class="title function_ invoke__">String</span>(s) =&gt; &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">literal</span> = Expr::Literal &#123;</span><br><span class="line">                span,</span><br><span class="line">                value: Literal::<span class="title function_ invoke__">String</span>(s.<span class="title function_ invoke__">to_string</span>()),</span><br><span class="line">            &#125;;</span><br><span class="line">            values.<span class="title function_ invoke__">push</span>(literal);</span><br><span class="line">        &#125;</span><br><span class="line">        _ =&gt; &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_ invoke__">Err</span>(ErrorCode::<span class="title function_ invoke__">SemanticError</span>(</span><br><span class="line">                <span class="string">&quot;The subquery of `pivot in` must return a string type&quot;</span>,</span><br><span class="line">            )</span><br><span class="line">            .<span class="title function_ invoke__">set_span</span>(span));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>【<strong>review-2</strong>】针对于 subquery 返回的每个 String 不需要设置 span，使用 subquery 的 span 即可。</p></li><li><p>【<strong>review-3</strong>】使用 <code>block.num_columns()</code> 计算 column 的数量。</p>  <figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 原版</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">columns</span> = block.<span class="title function_ invoke__">columns</span>();</span><br><span class="line"><span class="keyword">if</span> columns.<span class="title function_ invoke__">len</span>() != <span class="number">1</span> &#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 修改后</span></span><br><span class="line"><span class="keyword">if</span> block.<span class="title function_ invoke__">num_columns</span>() != <span class="number">1</span> &#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>【<strong>review-4</strong>】将 sample_executor 和 subquery_executor 合并成一个 query_executor，实现不同的函数用来做区分。</p></li><li><p>【<strong>review-5</strong>】对返回的 ErrorCode 设置 span。→ <a href="https://www.notion.so/span-123e3d1c52c68003850bf86ae43a4c3d?pvs=21">span</a></p><p>不使用 span：</p>  <figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="title function_ invoke__">Err</span>(ErrorCode::<span class="title function_ invoke__">SemanticError</span>(</span><br><span class="line">    <span class="string">&quot;The subquery of `pivot in` must return one column&quot;</span>,</span><br><span class="line">));</span><br></pre></td></tr></table></figure>  <figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">MySQL [dev]<span class="operator">&gt;</span> <span class="keyword">SELECT</span> <span class="operator">*</span>  <span class="keyword">FROM</span> (<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> monthly_sales) PIVOT(<span class="built_in">SUM</span>(amount) <span class="keyword">FOR</span> <span class="keyword">MONTH</span> <span class="keyword">IN</span> (<span class="keyword">select</span> <span class="keyword">distinct</span> <span class="keyword">month</span>, <span class="keyword">month</span> <span class="keyword">from</span> monthly_sales)) <span class="keyword">ORDER</span> <span class="keyword">BY</span> EMPID;</span><br><span class="line">ERROR <span class="number">1105</span> (HY000): SemanticError. Code: <span class="number">1065</span>, Text <span class="operator">=</span> The subquery <span class="keyword">of</span> `pivot <span class="keyword">in</span>` must <span class="keyword">return</span> <span class="keyword">one</span> column.</span><br></pre></td></tr></table></figure><hr /><p>使用 span：</p>  <figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="title function_ invoke__">Err</span>(ErrorCode::<span class="title function_ invoke__">SemanticError</span>(</span><br><span class="line">    <span class="string">&quot;The subquery of `pivot in` must return one column&quot;</span>,</span><br><span class="line">)</span><br><span class="line">.<span class="title function_ invoke__">set_span</span>(span));</span><br></pre></td></tr></table></figure>  <figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">MySQL [dev]<span class="operator">&gt;</span> <span class="keyword">SELECT</span> <span class="operator">*</span>  <span class="keyword">FROM</span> (<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> monthly_sales) PIVOT(<span class="built_in">SUM</span>(amount) <span class="keyword">FOR</span> <span class="keyword">MONTH</span> <span class="keyword">IN</span> (<span class="keyword">select</span> <span class="keyword">distinct</span> empid <span class="keyword">from</span> monthly_sales)) <span class="keyword">ORDER</span> <span class="keyword">BY</span> EMPID;</span><br><span class="line">ERROR <span class="number">1105</span> (HY000): SemanticError. Code: <span class="number">1065</span>, Text <span class="operator">=</span> error: </span><br><span class="line">  <span class="comment">--&gt; SQL:1:78</span></span><br><span class="line">  <span class="operator">|</span></span><br><span class="line"><span class="number">1</span> <span class="operator">|</span> <span class="keyword">SELECT</span> <span class="operator">*</span>  <span class="keyword">FROM</span> (<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> monthly_sales) PIVOT(<span class="built_in">SUM</span>(amount) <span class="keyword">FOR</span> <span class="keyword">MONTH</span> <span class="keyword">IN</span> (<span class="keyword">select</span> <span class="keyword">distinct</span> empid <span class="keyword">from</span> monthly_sales)) <span class="keyword">ORDER</span> <span class="keyword">BY</span> EMPID</span><br><span class="line">  <span class="operator">|</span>                                                                              <span class="operator">^</span><span class="operator">^</span><span class="operator">^</span><span class="operator">^</span><span class="operator">^</span><span class="operator">^</span><span class="operator">^</span><span class="operator">^</span><span class="operator">^</span><span class="operator">^</span><span class="operator">^</span><span class="operator">^</span><span class="operator">^</span><span class="operator">^</span><span class="operator">^</span><span class="operator">^</span><span class="operator">^</span><span class="operator">^</span><span class="operator">^</span><span class="operator">^</span><span class="operator">^</span><span class="operator">^</span><span class="operator">^</span><span class="operator">^</span><span class="operator">^</span><span class="operator">^</span><span class="operator">^</span><span class="operator">^</span><span class="operator">^</span><span class="operator">^</span><span class="operator">^</span><span class="operator">^</span><span class="operator">^</span><span class="operator">^</span><span class="operator">^</span><span class="operator">^</span><span class="operator">^</span><span class="operator">^</span><span class="operator">^</span><span class="operator">^</span> The subquery <span class="keyword">of</span> `pivot <span class="keyword">in</span>` must <span class="keyword">return</span> a string type</span><br><span class="line"></span><br><span class="line">.</span><br></pre></td></tr></table></figure></li></ul><h2 id="33-bugs"><a class="markdownIt-Anchor" href="#33-bugs"></a> 3.3 bugs</h2><ul><li><p>【<strong>bug-1</strong>】因为需要两次用到 pivot 变量，所以会报 error: use of moved value 的错误。→ <a href="https://www.notion.so/error-use-of-moved-value-11fe3d1c52c68078839ae6d3f66d8f62?pvs=21">error: use of moved value</a></p><p>把 pivot 和 unpivot 挪出去，改成两个单独的函数。</p></li><li><p>【<strong>bug-2</strong>】rewrite_pivot 是非 async 函数，但是 subquery_executor.execute_query_with_sql_string 是 async 函数，rewrite_pivot 中需要调用 subquery_executor.execute_query_with_sql_string。所以会报错：<code>await</code> is only allowed inside <code>async</code> functions and blocks。→ <a href="https://www.notion.so/async-async-125e3d1c52c680008cb5e6a86c6a6554?pvs=21">在非 async 函数里调用 async 函数</a></p><p><code>databend_common_base::runtime::block_on</code></p></li></ul><h1 id="4-测试"><a class="markdownIt-Anchor" href="#4-测试"></a> 4 测试</h1><h2 id="41-功能测试"><a class="markdownIt-Anchor" href="#41-功能测试"></a> 4.1 功能测试</h2><p>与 snowflake 语法保持一致：</p><ul><li>pivot 支持三种 subquery，<code>from + subquery</code>、<code>in + subquery</code>、<code>from + subquery + in + subquery</code>。</li><li>unpivot 只支持 <code>from + subquery</code> 一种。</li></ul><h3 id="411-手动测试"><a class="markdownIt-Anchor" href="#411-手动测试"></a> 4.1.1 手动测试</h3><ul><li><p><strong>测试 Pivot</strong></p><ul><li><p><strong>Create the monthly_sales table</strong></p>  <figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE TABLE</span> monthly_sales(</span><br><span class="line">  empid <span class="type">INT</span>, </span><br><span class="line">  amount <span class="type">INT</span>, </span><br><span class="line">  <span class="keyword">month</span> <span class="type">VARCHAR</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure></li><li><p><strong>Insert sales data</strong></p>  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT INTO</span> monthly_sales <span class="keyword">VALUES</span></span><br><span class="line">  (<span class="number">1</span>, <span class="number">10000</span>, <span class="string">&#x27;JAN&#x27;</span>),</span><br><span class="line">  (<span class="number">1</span>, <span class="number">400</span>, <span class="string">&#x27;JAN&#x27;</span>),</span><br><span class="line">  (<span class="number">2</span>, <span class="number">4500</span>, <span class="string">&#x27;JAN&#x27;</span>),</span><br><span class="line">  (<span class="number">2</span>, <span class="number">35000</span>, <span class="string">&#x27;JAN&#x27;</span>),</span><br><span class="line">  (<span class="number">1</span>, <span class="number">5000</span>, <span class="string">&#x27;FEB&#x27;</span>),</span><br><span class="line">  (<span class="number">1</span>, <span class="number">3000</span>, <span class="string">&#x27;FEB&#x27;</span>),</span><br><span class="line">  (<span class="number">2</span>, <span class="number">200</span>, <span class="string">&#x27;FEB&#x27;</span>),</span><br><span class="line">  (<span class="number">2</span>, <span class="number">90500</span>, <span class="string">&#x27;FEB&#x27;</span>),</span><br><span class="line">  (<span class="number">1</span>, <span class="number">6000</span>, <span class="string">&#x27;MAR&#x27;</span>),</span><br><span class="line">  (<span class="number">1</span>, <span class="number">5000</span>, <span class="string">&#x27;MAR&#x27;</span>),</span><br><span class="line">  (<span class="number">2</span>, <span class="number">2500</span>, <span class="string">&#x27;MAR&#x27;</span>),</span><br><span class="line">  (<span class="number">2</span>, <span class="number">9500</span>, <span class="string">&#x27;MAR&#x27;</span>),</span><br><span class="line">  (<span class="number">1</span>, <span class="number">8000</span>, <span class="string">&#x27;APR&#x27;</span>),</span><br><span class="line">  (<span class="number">1</span>, <span class="number">10000</span>, <span class="string">&#x27;APR&#x27;</span>),</span><br><span class="line">  (<span class="number">2</span>, <span class="number">800</span>, <span class="string">&#x27;APR&#x27;</span>),</span><br><span class="line">  (<span class="number">2</span>, <span class="number">4500</span>, <span class="string">&#x27;APR&#x27;</span>);</span><br></pre></td></tr></table></figure></li><li><p><strong>Pivot（原版）</strong></p>  <figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> </span><br><span class="line"><span class="keyword">FROM</span> monthly_sales</span><br><span class="line">PIVOT(<span class="built_in">SUM</span>(amount) <span class="keyword">FOR</span> <span class="keyword">MONTH</span> <span class="keyword">IN</span> (<span class="string">&#x27;JAN&#x27;</span>, <span class="string">&#x27;FEB&#x27;</span>, <span class="string">&#x27;MAR&#x27;</span>, <span class="string">&#x27;APR&#x27;</span>))</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> EMPID;</span><br></pre></td></tr></table></figure></li><li><p><strong>from + subquery</strong></p>  <figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> (<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> monthly_sales)</span><br><span class="line">PIVOT(<span class="built_in">SUM</span>(amount) <span class="keyword">FOR</span> <span class="keyword">MONTH</span> <span class="keyword">IN</span> (<span class="string">&#x27;JAN&#x27;</span>, <span class="string">&#x27;FEB&#x27;</span>, <span class="string">&#x27;MAR&#x27;</span>, <span class="string">&#x27;APR&#x27;</span>))</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> EMPID;</span><br></pre></td></tr></table></figure></li><li><p><strong>in + subquery</strong></p>  <figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> </span><br><span class="line"><span class="keyword">FROM</span> monthly_sales</span><br><span class="line">PIVOT(<span class="built_in">SUM</span>(amount) <span class="keyword">FOR</span> <span class="keyword">MONTH</span> <span class="keyword">IN</span> (<span class="keyword">select</span> <span class="keyword">distinct</span> <span class="keyword">month</span> <span class="keyword">from</span> monthly_sales))</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> EMPID;</span><br></pre></td></tr></table></figure></li><li><p><strong>from + in + subquery</strong></p>  <figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> </span><br><span class="line"><span class="keyword">FROM</span> (<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> monthly_sales)</span><br><span class="line">PIVOT(<span class="built_in">SUM</span>(amount) <span class="keyword">FOR</span> <span class="keyword">MONTH</span> <span class="keyword">IN</span> (<span class="keyword">select</span> <span class="keyword">distinct</span> <span class="keyword">month</span> <span class="keyword">from</span> monthly_sales))</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> EMPID;</span><br></pre></td></tr></table></figure></li><li><p><strong>Answer</strong></p>  <figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="operator">+</span><span class="comment">-------+-------+-------+-------+-------+</span></span><br><span class="line"><span class="operator">|</span> empid <span class="operator">|</span> jan   <span class="operator">|</span> feb   <span class="operator">|</span> mar   <span class="operator">|</span> apr   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+-------+-------+-------+-------+</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">1</span> <span class="operator">|</span> <span class="number">10400</span> <span class="operator">|</span>  <span class="number">8000</span> <span class="operator">|</span> <span class="number">11000</span> <span class="operator">|</span> <span class="number">18000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">2</span> <span class="operator">|</span> <span class="number">39500</span> <span class="operator">|</span> <span class="number">90700</span> <span class="operator">|</span> <span class="number">12000</span> <span class="operator">|</span>  <span class="number">5300</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+-------+-------+-------+-------+</span></span><br></pre></td></tr></table></figure></li></ul></li><li><p><strong>测试 Unpivot</strong></p><ul><li><p><strong>Create the unpivoted_monthly_sales table</strong></p>  <figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE TABLE</span> unpivoted_monthly_sales(</span><br><span class="line">  empid <span class="type">INT</span>,</span><br><span class="line">  jan <span class="type">INT</span>,</span><br><span class="line">  feb <span class="type">INT</span>,</span><br><span class="line">  mar <span class="type">INT</span>,</span><br><span class="line">  apr <span class="type">INT</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure></li><li><p><strong>Insert sales data</strong></p>  <figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">INSERT INTO</span> unpivoted_monthly_sales <span class="keyword">VALUES</span></span><br><span class="line">  (<span class="number">1</span>, <span class="number">10400</span>,  <span class="number">8000</span>, <span class="number">11000</span>, <span class="number">18000</span>),</span><br><span class="line">  (<span class="number">2</span>, <span class="number">39500</span>, <span class="number">90700</span>, <span class="number">12000</span>,  <span class="number">5300</span>);</span><br></pre></td></tr></table></figure></li><li><p><strong>unpivot（原版）</strong></p>  <figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> unpivoted_monthly_sales</span><br><span class="line">    UNPIVOT (amount</span><br><span class="line">    <span class="keyword">FOR</span> <span class="keyword">month</span> <span class="keyword">IN</span> (jan, feb, mar, apr));</span><br></pre></td></tr></table></figure></li><li><p><strong>from + subquery</strong></p>  <figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> (<span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> monthly_sales_1)</span><br><span class="line">  UNPIVOT(sales <span class="keyword">FOR</span> <span class="keyword">month</span> <span class="keyword">IN</span> (jan, feb, mar, april))</span><br><span class="line">  <span class="keyword">ORDER</span> <span class="keyword">BY</span> empid</span><br></pre></td></tr></table></figure></li><li><p><strong>Answer</strong></p>  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">+</span><span class="comment">-------+-------+--------+</span></span><br><span class="line"><span class="operator">|</span> empid <span class="operator">|</span> <span class="keyword">month</span> <span class="operator">|</span> amount <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+-------+--------+</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">1</span> <span class="operator">|</span> jan   <span class="operator">|</span>  <span class="number">10400</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">1</span> <span class="operator">|</span> feb   <span class="operator">|</span>   <span class="number">8000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">1</span> <span class="operator">|</span> mar   <span class="operator">|</span>  <span class="number">11000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">1</span> <span class="operator">|</span> apr   <span class="operator">|</span>  <span class="number">18000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">2</span> <span class="operator">|</span> jan   <span class="operator">|</span>  <span class="number">39500</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">2</span> <span class="operator">|</span> feb   <span class="operator">|</span>  <span class="number">90700</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">2</span> <span class="operator">|</span> mar   <span class="operator">|</span>  <span class="number">12000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">2</span> <span class="operator">|</span> apr   <span class="operator">|</span>   <span class="number">5300</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+-------+--------+</span></span><br></pre></td></tr></table></figure></li></ul></li></ul><h3 id="412-单元测试ast-相关"><a class="markdownIt-Anchor" href="#412-单元测试ast-相关"></a> 4.1.2 单元测试（ast 相关）</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">make unit-test</span><br></pre></td></tr></table></figure><p>parser 改了会导致之前的测试失败，修复下面两个文件：</p><ol><li><code>src/query/ast/tests/it/testdata/stmt.txt</code></li><li><code>src/query/ast/tests/it/testdata/query.txt</code></li></ol><hr /><p>另外在 test_query 函数加上一个 pivot &amp; unpivot 带 subquery 的测试用例，相关文件：<code>src/query/ast/tests/it/parser.rs</code>。</p><h3 id="413-逻辑测试sql-执行结果"><a class="markdownIt-Anchor" href="#413-逻辑测试sql-执行结果"></a> 4.1.3 逻辑测试（sql 执行结果）</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">make sqllogic-test</span><br></pre></td></tr></table></figure><p>为了加快测试速度，可以<strong>指定目录</strong>进行执行，甚至可以<strong>修改文件名</strong>使其在当前目录先执行：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">./target/debug/databend-sqllogictests --handlers mysql --run_dir query</span><br></pre></td></tr></table></figure><hr /><p>添加 pivot &amp; unpivot 相关 sql 查询，相关文件：</p><ul><li><code>tests/sqllogictests/suites/query/pivot.test</code></li><li><code>tests/sqllogictests/suites/query/unpivot.test</code></li></ul><h2 id="42-性能测试"><a class="markdownIt-Anchor" href="#42-性能测试"></a> 4.2 性能测试</h2><h1 id="5-难点"><a class="markdownIt-Anchor" href="#5-难点"></a> 5 难点</h1><h1 id="6-todo"><a class="markdownIt-Anchor" href="#6-todo"></a> 6 TODO</h1><h1 id="x-参考"><a class="markdownIt-Anchor" href="#x-参考"></a> X 参考</h1><ul><li><a href="https://docs.snowflake.com/en/sql-reference/constructs/pivot">https://docs.snowflake.com/en/sql-reference/constructs/pivot</a></li><li><a href="https://docs.snowflake.com/en/sql-reference/constructs/unpivot">https://docs.snowflake.com/en/sql-reference/constructs/unpivot</a></li><li><a href="https://docs.databend.com/sql/sql-commands/query-syntax/query-pivot">https://docs.databend.com/sql/sql-commands/query-syntax/query-pivot</a></li><li><a href="https://docs.databend.com/sql/sql-commands/query-syntax/query-unpivot">https://docs.databend.com/sql/sql-commands/query-syntax/query-unpivot</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;1-任务背景&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#1-任务背景&quot;&gt;&lt;/a&gt; 1 任务背景&lt;/h1&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Issue&lt;/strong&gt;：&lt;a href=&quot;https://github.com/dat</summary>
      
    
    
    
    <category term="DB" scheme="https://dragonliu2018.github.io/categories/DB/"/>
    
    <category term="databend" scheme="https://dragonliu2018.github.io/categories/DB/databend/"/>
    
    <category term="函数/表达式" scheme="https://dragonliu2018.github.io/categories/DB/%E5%87%BD%E6%95%B0-%E8%A1%A8%E8%BE%BE%E5%BC%8F/"/>
    
    
    <category term="pr" scheme="https://dragonliu2018.github.io/tags/pr/"/>
    
  </entry>
  
  <entry>
    <title>[doris][Status] Implement format methods for Status</title>
    <link href="https://dragonliu2018.github.io/2025/09/14/doris-Status-Implement-format-methods-for-Status/"/>
    <id>https://dragonliu2018.github.io/2025/09/14/doris-Status-Implement-format-methods-for-Status/</id>
    <published>2025-09-14T09:26:44.000Z</published>
    <updated>2025-09-23T01:05:52.936Z</updated>
    
    <content type="html"><![CDATA[<h1 id="1-issue-介绍"><a class="markdownIt-Anchor" href="#1-issue-介绍"></a> 1 issue 介绍</h1><p>当前 <code>Status</code> 类型进行 format 时，需要调用 <code>to_string</code> 函数：</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">fmt::format(<span class="string">&quot;&#123;&#125;&quot;</span>, status.<span class="built_in">to_string</span>());</span><br></pre></td></tr></table></figure><p>想要的效果是只需要传入 Status 类型即可：</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">fmt::format(<span class="string">&quot;&#123;&#125;&quot;</span>, status);</span><br></pre></td></tr></table></figure><h1 id="2-实现"><a class="markdownIt-Anchor" href="#2-实现"></a> 2 实现</h1><h2 id="21-解析"><a class="markdownIt-Anchor" href="#21-解析"></a> 2.1 解析</h2><p><code>fmt</code> 库提供了一个类模板 <code>fmt::formatter</code>，通过模板特化为 <code>Status</code> 类型提供适当的格式化方式。</p><p>然后实现 <code>parse</code> 和 <code>format</code> 函数即可：</p><ul><li><strong><code>parse</code></strong> 函数负责解析格式字符串。在通常情况下，用户可能不需要提供自己的 <strong><code>parse</code></strong> 函数，而可以使用 fmt 默认提供的版本，该版本简单地返回解析上下文的开始迭代器。</li><li><strong><code>format</code></strong> 函数是用户必须提供的关键成员函数。它定义了如何将自定义类型格式化为字符串。</li></ul><h2 id="22-功能代码"><a class="markdownIt-Anchor" href="#22-功能代码"></a> 2.2 功能代码</h2><blockquote><p>👉 **参考：**<a href="https://wgml.pl/blog/formatting-user-defined-types-fmt.html">https://wgml.pl/blog/formatting-user-defined-types-fmt.html</a></p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// specify formatter for Status</span></span><br><span class="line"><span class="keyword">template</span> &lt;&gt;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">fmt</span>::formatter&lt;doris::Status&gt; &#123;</span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> ParseContext&gt;</span><br><span class="line">    <span class="function"><span class="keyword">constexpr</span> <span class="keyword">auto</span> <span class="title">parse</span><span class="params">(ParseContext&amp; ctx)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ctx.<span class="built_in">begin</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> FormatContext&gt;</span><br><span class="line">    <span class="function"><span class="keyword">auto</span> <span class="title">format</span><span class="params">(doris::Status <span class="type">const</span>&amp; status, FormatContext&amp; ctx)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> fmt::format_to(ctx.<span class="built_in">out</span>(), <span class="string">&quot;&#123;&#125;&quot;</span>, status.<span class="built_in">to_string</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="23-测试代码"><a class="markdownIt-Anchor" href="#23-测试代码"></a> 2.3 测试代码</h2><p>实现完成后，编写测试样例，这里需要注意覆盖率。</p><p>reviewer 提出的建议是：</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">please add <span class="number">3</span> tests：</span><br><span class="line"><span class="number">1.</span> status == ok</span><br><span class="line"><span class="number">2.</span> status == error &amp;&amp; has stacktrace</span><br><span class="line"><span class="number">3.</span> status == error &amp;&amp; <span class="keyword">do</span> <span class="keyword">not</span> have stacktrace</span><br></pre></td></tr></table></figure><h1 id="3-问题"><a class="markdownIt-Anchor" href="#3-问题"></a> 3 问题</h1><h2 id="31-ld-symbols-not-found-for-architecture-x86_64"><a class="markdownIt-Anchor" href="#31-ld-symbols-not-found-for-architecture-x86_64"></a> 3.1 ld: symbol(s) not found for architecture x86_64</h2><p>在本地 macos 上尝试写了个测试程序，但是发生下面的报错：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">➜  test-reset git:(main) ✗ g++ test.cpp -std=c++20 -o <span class="built_in">test</span></span><br><span class="line">Undefined symbols <span class="keyword">for</span> architecture x86_64:</span><br><span class="line">  <span class="string">&quot;void fmt::v10::detail::vformat_to&lt;char&gt;(fmt::v10::detail::buffer&lt;char&gt;&amp;, fmt::v10::basic_string_view&lt;char&gt;, fmt::v10::detail::vformat_args&lt;char&gt;::type, fmt::v10::detail::locale_ref)&quot;</span>, referenced from:</span><br><span class="line">      <span class="built_in">fmt</span>::v10::appender <span class="built_in">fmt</span>::v10::vformat_to&lt;<span class="built_in">fmt</span>::v10::appender, 0&gt;(<span class="built_in">fmt</span>::v10::appender, <span class="built_in">fmt</span>::v10::basic_string_view&lt;char&gt;, <span class="built_in">fmt</span>::v10::basic_format_args&lt;<span class="built_in">fmt</span>::v10::basic_format_context&lt;<span class="built_in">fmt</span>::v10::appender, char&gt; &gt;) <span class="keyword">in</span> test-878b3f.o</span><br><span class="line">  <span class="string">&quot;fmt::v10::detail::assert_fail(char const*, int, char const*)&quot;</span>, referenced from:</span><br><span class="line">      std::__1::make_unsigned&lt;long&gt;::<span class="built_in">type</span> <span class="built_in">fmt</span>::v10::detail::to_unsigned&lt;long&gt;(long) <span class="keyword">in</span> test-878b3f.o</span><br><span class="line">  <span class="string">&quot;fmt::v10::vprint(fmt::v10::basic_string_view&lt;char&gt;, fmt::v10::basic_format_args&lt;fmt::v10::basic_format_context&lt;fmt::v10::appender, char&gt; &gt;)&quot;</span>, referenced from:</span><br><span class="line">      _main <span class="keyword">in</span> test-878b3f.o</span><br><span class="line">ld: symbol(s) not found <span class="keyword">for</span> architecture x86_64</span><br><span class="line">clang: error: linker <span class="built_in">command</span> failed with <span class="built_in">exit</span> code 1 (use -v to see invocation)</span><br></pre></td></tr></table></figure><p><strong>解决</strong>：原因是未链接 fmt 库文件</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">g++ test.cpp -std=c++20 -o <span class="built_in">test</span> -lfmt</span><br></pre></td></tr></table></figure><p><strong>参考</strong>：<a href="https://stackoverflow.com/questions/56608684/how-to-use-the-fmt-library-without-getting-undefined-symbols-for-architecture-x">https://stackoverflow.com/questions/56608684/how-to-use-the-fmt-library-without-getting-undefined-symbols-for-architecture-x</a></p><h2 id="32-fmtformatter-模板特化代码不能在-doris-的-namespace"><a class="markdownIt-Anchor" href="#32-fmtformatter-模板特化代码不能在-doris-的-namespace"></a> 3.2 <code>fmt::formatter</code> 模板特化代码不能在 doris 的 namespace</h2><p>开始将特化代码放在了 doris namespace 中，发生了下面的报错：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Class template specialization of <span class="string">&#x27;formatter&#x27;</span> not <span class="keyword">in</span> a namespace enclosing <span class="string">&#x27;v8&#x27;</span> is a Microsoft extension clang(-Wmicrosoft-template)</span><br><span class="line"></span><br><span class="line">[core.h(707, 8): ] Explicitly specialized declaration is here</span><br></pre></td></tr></table></figure><p><strong>解决</strong>：</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">namespace</span> doris &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// doris code</span></span><br><span class="line"></span><br><span class="line">&#125; <span class="comment">// end doris_namespace</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// define formatter here</span></span><br></pre></td></tr></table></figure><p>**参考：**<a href="https://github.com/fmtlib/fmt/issues/2767">https://github.com/fmtlib/fmt/issues/2767</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;1-issue-介绍&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#1-issue-介绍&quot;&gt;&lt;/a&gt; 1 issue 介绍&lt;/h1&gt;
&lt;p&gt;当前 &lt;code&gt;Status&lt;/code&gt; 类型进行 format 时，需要调用 &lt;code&gt;</summary>
      
    
    
    
    <category term="DB" scheme="https://dragonliu2018.github.io/categories/DB/"/>
    
    <category term="doris" scheme="https://dragonliu2018.github.io/categories/DB/doris/"/>
    
    
    <category term="pr" scheme="https://dragonliu2018.github.io/tags/pr/"/>
    
  </entry>
  
  <entry>
    <title>[Tool] Hexo 使用教程</title>
    <link href="https://dragonliu2018.github.io/2025/09/13/Tool-Hexo-%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/"/>
    <id>https://dragonliu2018.github.io/2025/09/13/Tool-Hexo-%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/</id>
    <published>2025-09-13T15:37:08.000Z</published>
    <updated>2025-09-23T01:03:51.746Z</updated>
    
    <content type="html"><![CDATA[<h1 id="环境准备"><a class="markdownIt-Anchor" href="#环境准备"></a> 环境准备</h1><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">➜  nvm --version</span><br><span class="line">0.39.1</span><br><span class="line">➜  node -v</span><br><span class="line">v24.8.0</span><br><span class="line">➜  npm -v</span><br><span class="line">11.6.0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装 Hexo</span></span><br><span class="line">npm install -g hexo-cli </span><br></pre></td></tr></table></figure><h1 id="本地运行-hexo"><a class="markdownIt-Anchor" href="#本地运行-hexo"></a> 本地运行 Hexo</h1><ol><li><p>初始化 hexo，生成 hexo-blog 目录</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">hexo init hexo-blog</span><br></pre></td></tr></table></figure></li><li><p>进入 hexo-blog 目录，下载 pure 主题和 source 文章</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd hexo-blog</span><br><span class="line"></span><br><span class="line">git clone https://github.com/Dragonliu2018/hexo-theme-pure.git themes/pure</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除默认生成的 _posts 目录</span></span><br><span class="line">rm -rf source/_posts</span><br><span class="line">git clone https://github.com/Dragonliu2018/hexo-source.git source</span><br></pre></td></tr></table></figure></li><li><p>配置 pure，<a href="https://github.com/Dragonliu2018/hexo-theme-pure">ref link</a></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">npm install hexo-wordcount --save</span><br><span class="line">npm install hexo-generator-json-content --save</span><br><span class="line">npm install hexo-generator-feed --save</span><br><span class="line">npm install hexo-generator-sitemap --save</span><br><span class="line">npm install hexo-generator-baidu-sitemap --save</span><br><span class="line">npm install hexo-neat --save</span><br><span class="line">npm install hexo-translate-title --save</span><br><span class="line">npm un hexo-renderer-marked --save</span><br><span class="line">npm i hexo-renderer-markdown-it-plus --save</span><br><span class="line">npm install hexo-deployer-git --save</span><br></pre></td></tr></table></figure></li><li><p>修改 _config.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 页面中分类等导航词的语言</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">language:</span> <span class="string">en</span></span><br><span class="line"><span class="string">+</span> <span class="attr">language:</span> <span class="string">zh-CN</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 搜索界面的分类部分拼接 url</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">url:</span> <span class="string">http://example.com</span></span><br><span class="line"><span class="string">+</span> <span class="attr">url:</span> <span class="string">https://dragonliu2018.github.io</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置主题</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">theme:</span> <span class="string">landscape</span></span><br><span class="line"><span class="string">+</span> <span class="attr">theme:</span> <span class="string">pure</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置部署</span></span><br><span class="line"><span class="attr">deploy:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">git</span></span><br><span class="line">  <span class="attr">repo:</span> <span class="string">https://github.com/dragonliu2018/dragonliu2018.github.io.git</span></span><br><span class="line">  <span class="attr">branch:</span> <span class="string">master</span></span><br></pre></td></tr></table></figure></li><li><p>运行 hexo</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">hexo g</span><br><span class="line">hexo s</span><br></pre></td></tr></table></figure></li></ol><h1 id="部署-github"><a class="markdownIt-Anchor" href="#部署-github"></a> 部署 Github</h1><blockquote><p>参考：<a href="https://hexo.io/docs/one-command-deployment">https://hexo.io/docs/one-command-deployment</a></p></blockquote><ol><li><p>安装 hexo-deployer-git</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">npm install hexo-deployer-git --save</span><br></pre></td></tr></table></figure></li><li><p>修改项目根目录 blog 下的 <code>_config.yml</code></p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">deploy:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">git</span></span><br><span class="line">  <span class="attr">repo:</span> <span class="string">https://github.com/dragonliu2018/dragonliu2018.github.io.git</span></span><br><span class="line">  <span class="attr">branch:</span> <span class="string">master</span></span><br></pre></td></tr></table></figure></li><li><p>部署</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">hexo g</span><br></pre></td></tr></table></figure></li></ol><h1 id="常用命令"><a class="markdownIt-Anchor" href="#常用命令"></a> 常用命令</h1><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">hexo clean</span><br><span class="line">hexo g</span><br><span class="line">hexo s</span><br><span class="line">hexo d</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;环境准备&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#环境准备&quot;&gt;&lt;/a&gt; 环境准备&lt;/h1&gt;
&lt;figure class=&quot;highlight shell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;spa</summary>
      
    
    
    
    <category term="Tool" scheme="https://dragonliu2018.github.io/categories/Tool/"/>
    
    <category term="Hexo" scheme="https://dragonliu2018.github.io/categories/Tool/Hexo/"/>
    
    
  </entry>
  
</feed>
