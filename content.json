{"meta":{"title":"Hexo","subtitle":"","description":"","author":"John Doe","url":"https://dragonliu2018.github.io","root":"/"},"pages":[{"title":"å‹æƒ…é“¾æ¥","date":"2019-09-13T08:58:45.000Z","updated":"2025-09-13T14:32:57.218Z","comments":true,"path":"link/index.html","permalink":"https://dragonliu2018.github.io/link/index.html","excerpt":"","text":""},{"title":"çœ‹æ¿","date":"2025-09-13T14:32:57.212Z","updated":"2025-09-13T14:32:57.212Z","comments":false,"path":"about/index.html","permalink":"https://dragonliu2018.github.io/about/index.html","excerpt":"","text":"è”ç³»æ–¹å¼ï¼šdragonliu2018@gmail.com 1 åˆ†ç±» CTF Web Pwn Reverse Crypto Misc WP æ¶æ„ä»£ç  ç¯å¢ƒä¸å·¥å…· ç½‘ç»œå®‰å…¨ æ¼æ´ å®‰å…¨é˜…è¯» é¢è¯•"},{"title":"å…‰å½±æµå¹´","date":"2019-09-13T08:56:36.000Z","updated":"2025-09-13T14:32:57.216Z","comments":true,"path":"gallery/index.html","permalink":"https://dragonliu2018.github.io/gallery/index.html","excerpt":"","text":""},{"title":"åˆ†ç±»","date":"2025-09-13T14:32:57.214Z","updated":"2025-09-13T14:32:57.214Z","comments":false,"path":"categories/index.html","permalink":"https://dragonliu2018.github.io/categories/index.html","excerpt":"","text":""},{"title":"é‚£äº›å¹´ï¼Œå¬è¿‡çš„éŸ³ä¹","date":"2025-09-13T14:32:57.220Z","updated":"2025-09-13T14:32:57.220Z","comments":true,"path":"music/index.html","permalink":"https://dragonliu2018.github.io/music/index.html","excerpt":"","text":"&#123;% meting &quot;7429975963&quot; &quot;tencent&quot; &quot;playlist&quot; %&#125;&#123;% douban music 30121600 %&#125;"},{"title":"æ ‡ç­¾","date":"2025-09-13T14:32:57.223Z","updated":"2025-09-13T14:32:57.223Z","comments":false,"path":"tags/index.html","permalink":"https://dragonliu2018.github.io/tags/index.html","excerpt":"","text":""},{"title":"ä¸»é¢˜æ›´æ–°æ—¥å¿—","date":"2019-09-13T08:58:45.000Z","updated":"2025-09-13T14:32:57.225Z","comments":true,"path":"theme/index.html","permalink":"https://dragonliu2018.github.io/theme/index.html","excerpt":"","text":"æœ¬ç«™å½“å‰ä¸»é¢˜ä½¿ç”¨çš„æ˜¯Hexo Butterfly TODO åšå®¢ç›¸å†Œé¡µé¢ 2021 å¹´ 02 æœˆ 2æœˆ23æ—¥ï¼š æ·»åŠ èœå•-ä¸»é¢˜ æ›´æ”¹é¦–é¡µå›¾ç‰‡ï¼šç‚¹å‡»æŸ¥çœ‹ 2æœˆ26æ—¥ è§£å†³åšå®¢åŠ å¯†æ–‡ç« æœ¬åœ°æµ‹è¯•é€šè¿‡ï¼Œæäº¤åˆ°GitHubåæœªé€šè¿‡é—®é¢˜ï¼Œè®¿é—® https://dragonliu.tk å³å¯ã€‚å‚è€ƒï¼šhexo-blog-encrypt åœ¨ http ç¯å¢ƒä¸‹æ— æ³•ä½¿ç”¨çš„åŸå› åˆ†æ æ–‡ç« åŠ å¯†éƒ¨åˆ†ä½¿ç”¨ sweetalert æ¥ç¾åŒ–é”™è¯¯æç¤ºã€‚å‚è€ƒ"},{"title":"Repositories","date":"2025-09-13T14:32:57.222Z","updated":"2025-09-13T14:32:57.222Z","comments":false,"path":"repository/index.html","permalink":"https://dragonliu2018.github.io/repository/index.html","excerpt":"","text":""}],"posts":[{"title":"[Databend][pr] pivot æ”¯æŒ subquery","slug":"Databend-pr-pivot-æ”¯æŒ-subquery","date":"2025-09-14T09:45:42.000Z","updated":"2025-09-14T13:04:44.992Z","comments":true,"path":"2025/09/14/Databend-pr-pivot-æ”¯æŒ-subquery/","permalink":"https://dragonliu2018.github.io/2025/09/14/Databend-pr-pivot-%E6%94%AF%E6%8C%81-subquery/","excerpt":"","text":"1 ä»»åŠ¡èƒŒæ™¯ Issueï¼šhttps://github.com/databendlabs/databend/issues/16556 **PRï¼š**https://github.com/databendlabs/databend/pull/16631 1.1 ä»»åŠ¡ä»‹ç» ç›®å‰ databend ä¸­çš„ pivot å’Œ unpivot ä¸æ”¯æŒ FROM/IN + subqueryã€‚â†’ æ–‡æ¡£é“¾æ¥ è¦æ±‚å®ç°ç±»ä¼¼äº snowflake çš„è¯­æ³•ï¼Œä¹Ÿå°±æ˜¯è®© pivot æ”¯æŒ FROM/IN + subqueryï¼Œunpivot æ”¯æŒ FROM + subqueryã€‚â†’ æ–‡æ¡£é“¾æ¥ databend PIVOT è¯­æ³• SELECT ...FROM ... PIVOT ( &lt;aggregate_function&gt; ( &lt;pivot_column&gt; ) FOR &lt;value_column&gt; IN ( &lt;pivot_value_1&gt; [ , &lt;pivot_value_2&gt; ... ] ) )[ ... ] &lt;aggregate_function&gt;ï¼šç”¨äºç»„åˆæ¥è‡ªpivot_columnçš„åˆ†ç»„å€¼çš„èšåˆå‡½æ•°ã€‚ &lt;pivot_column&gt;ï¼šå°†ä½¿ç”¨æŒ‡å®šçš„&lt;aggregate_function&gt;è¿›è¡Œèšåˆçš„åˆ—ã€‚ &lt;value_column&gt;ï¼šå…¶å”¯ä¸€å€¼å°†åœ¨æ—‹è½¬ç»“æœé›†ä¸­æˆä¸ºæ–°åˆ—çš„åˆ—ã€‚ &lt;pivot_value_N&gt;ï¼šæ¥è‡ª&lt;value_column&gt;çš„å”¯ä¸€å€¼ï¼Œå°†åœ¨æ—‹è½¬ç»“æœé›†ä¸­æˆä¸ºæ–°åˆ—ã€‚ databend UNPIVOT è¯­æ³• SELECT ...FROM ... UNPIVOT ( &lt;value_column&gt; FOR &lt;name_column&gt; IN ( &lt;column_list&gt; ) )[ ... ] &lt;value_column&gt;ï¼šå°†å­˜å‚¨ä» &lt;column_list&gt; ä¸­åˆ—å‡ºçš„åˆ—ä¸­æå–çš„å€¼çš„åˆ—ã€‚ &lt;name_column&gt;ï¼šå°†å­˜å‚¨ä»ä¸­æå–å€¼çš„åˆ—çš„åç§°çš„åˆ—ã€‚ &lt;column_list&gt;ï¼šè¦å–æ¶ˆé€è§†çš„åˆ—çš„åˆ—è¡¨ï¼Œç”¨é€—å·åˆ†éš”ã€‚ snowflake PIVOT è¯­æ³• 123456789101112SELECT ...FROM ... PIVOT ( &lt;aggregate_function&gt; ( &lt;pivot_column&gt; ) FOR &lt;value_column&gt; IN ( &lt;pivot_value_1&gt; [ , &lt;pivot_value_2&gt; ... ] | ANY [ ORDER BY ... ] | &lt;subquery&gt; ) [ DEFAULT ON NULL (&lt;value&gt;) ] )[ ... ] snowflake UNPIVOT è¯­æ³• SELECT ...FROM ... UNPIVOT [ &#123; INCLUDE | EXCLUDE &#125; NULLS ] ( &lt;value_column&gt; FOR &lt;name_column&gt; IN ( &lt;column_list&gt; ) )[ ... ] 1.2 ä»‹ç» pivot &amp; unpivot 1.2.1 pivotï¼ˆé€è§†ï¼Œä¸€åˆ—ä¸­çš„å±æ€§å€¼è½¬æˆå¤šä¸ªå¯¹åº”å±æ€§ï¼‰ https://docs.databend.com/sql/sql-commands/query-syntax/query-pivot PIVOTæ“ä½œé€šè¿‡æ—‹è½¬è¡¨æ ¼å¹¶åŸºäºæŒ‡å®šåˆ—èšåˆç»“æœæ¥è½¬æ¢è¡¨æ ¼ï¼Œè¿™æ˜¯ä¸€ä¸ªå¯¹äºæ€»ç»“å’Œåˆ†æå¤§é‡æ•°æ®ä»¥æ›´å¯è¯»æ ¼å¼æ˜¾ç¤ºéå¸¸æœ‰ç”¨çš„æ“ä½œã€‚ databend PIVOT è¯­æ³• SELECT ...FROM ... PIVOT ( &lt;aggregate_function&gt; ( &lt;pivot_column&gt; ) FOR &lt;value_column&gt; IN ( &lt;pivot_value_1&gt; [ , &lt;pivot_value_2&gt; ... ] ) )[ ... ] &lt;aggregate_function&gt;ï¼šç”¨äºç»„åˆæ¥è‡ªpivot_columnçš„åˆ†ç»„å€¼çš„èšåˆå‡½æ•°ã€‚ &lt;pivot_column&gt;ï¼šå°†ä½¿ç”¨æŒ‡å®šçš„&lt;aggregate_function&gt;è¿›è¡Œèšåˆçš„åˆ—ã€‚ &lt;value_column&gt;ï¼šå…¶å”¯ä¸€å€¼å°†åœ¨æ—‹è½¬ç»“æœé›†ä¸­æˆä¸ºæ–°åˆ—çš„åˆ—ã€‚ &lt;pivot_value_N&gt;ï¼šæ¥è‡ª&lt;value_column&gt;çš„å”¯ä¸€å€¼ï¼Œå°†åœ¨æ—‹è½¬ç»“æœé›†ä¸­æˆä¸ºæ–°åˆ—ã€‚ å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªåä¸º monthly_sales çš„è¡¨ï¼Œå…¶ä¸­åŒ…å«ä¸åŒå‘˜å·¥åœ¨ä¸åŒæœˆä»½çš„é”€å”®æ•°æ®ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨PIVOTæ“ä½œæ¥æ€»ç»“æ•°æ®å¹¶è®¡ç®—æ¯ä¸ªå‘˜å·¥åœ¨æ¯ä¸ªæœˆçš„æ€»é”€å”®é¢ã€‚ åˆ›å»ºå’Œæ’å…¥æ•°æ® 12345678910111213141516171819202122232425-- åˆ›å»ºmonthly_salesè¡¨CREATE TABLE monthly_sales( empid INT, amount INT, month VARCHAR);-- æ’å…¥é”€å”®æ•°æ®INSERT INTO monthly_sales VALUES (1, 10000, &#x27;JAN&#x27;), (1, 400, &#x27;JAN&#x27;), (2, 4500, &#x27;JAN&#x27;), (2, 35000, &#x27;JAN&#x27;), (1, 5000, &#x27;FEB&#x27;), (1, 3000, &#x27;FEB&#x27;), (2, 200, &#x27;FEB&#x27;), (2, 90500, &#x27;FEB&#x27;), (1, 6000, &#x27;MAR&#x27;), (1, 5000, &#x27;MAR&#x27;), (2, 2500, &#x27;MAR&#x27;), (2, 9500, &#x27;MAR&#x27;), (1, 8000, &#x27;APR&#x27;), (1, 10000, &#x27;APR&#x27;), (2, 800, &#x27;APR&#x27;), (2, 4500, &#x27;APR&#x27;); ä½¿ç”¨ PIVOT ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨PIVOTæ“ä½œæ¥è®¡ç®—æ¯ä¸ªå‘˜å·¥åœ¨æ¯ä¸ªæœˆçš„æ€»é”€å”®é¢ã€‚æˆ‘ä»¬å°†ä½¿ç”¨SUMèšåˆå‡½æ•°æ¥è®¡ç®—æ€»é”€å”®é¢ï¼ŒMONTH åˆ—å°†è¢«æ—‹è½¬ä»¥ä¸ºæ¯ä¸ªæœˆåˆ›å»ºæ–°åˆ—ã€‚ SELECT *FROM monthly_salesPIVOT(SUM(amount) FOR MONTH IN (&#x27;JAN&#x27;, &#x27;FEB&#x27;, &#x27;MAR&#x27;, &#x27;APR&#x27;))ORDER BY EMPID; è¾“å‡ºï¼š +-------+-------+-------+-------+-------+| empid | jan | feb | mar | apr |+-------+-------+-------+-------+-------+| 1 | 10400 | 8000 | 11000 | 18000 || 2 | 39500 | 90700 | 12000 | 5300 |+-------+-------+-------+-------+-------+ 1.2.2 unpivotï¼ˆå–æ¶ˆé€è§†ï¼Œå¤šä¸ªå±æ€§è½¬æˆä¸€åˆ—ä¸­å¯¹åº”çš„å±æ€§å€¼ï¼‰ https://docs.databend.com/sql/sql-commands/query-syntax/query-unpivot UNPIVOT æ“ä½œé€šè¿‡å°†åˆ—è½¬æ¢ä¸ºè¡Œæ¥æ—‹è½¬è¡¨ã€‚å®ƒæ˜¯ä¸€ä¸ªå…³ç³»æ“ä½œç¬¦ï¼Œæ¥å—ä¸¤åˆ—ï¼ˆæ¥è‡ªè¡¨æˆ–å­æŸ¥è¯¢ï¼‰ï¼Œä»¥åŠåˆ—çš„åˆ—è¡¨ï¼Œå¹¶ä¸ºåˆ—è¡¨ä¸­æŒ‡å®šçš„æ¯åˆ—ç”Ÿæˆä¸€è¡Œã€‚åœ¨æŸ¥è¯¢ä¸­ï¼Œå®ƒåœ¨ FROM å­å¥ä¸­æŒ‡å®šï¼Œä½äºè¡¨åæˆ–å­æŸ¥è¯¢ä¹‹åã€‚ databend UNPIVOT è¯­æ³• SELECT ...FROM ... UNPIVOT ( &lt;value_column&gt; FOR &lt;name_column&gt; IN ( &lt;column_list&gt; ) )[ ... ] &lt;value_column&gt;ï¼šå°†å­˜å‚¨ä» &lt;column_list&gt; ä¸­åˆ—å‡ºçš„åˆ—ä¸­æå–çš„å€¼çš„åˆ—ã€‚ &lt;name_column&gt;ï¼šå°†å­˜å‚¨ä»ä¸­æå–å€¼çš„åˆ—çš„åç§°çš„åˆ—ã€‚ &lt;column_list&gt;ï¼šè¦å–æ¶ˆé€è§†çš„åˆ—çš„åˆ—è¡¨ï¼Œç”¨é€—å·åˆ†éš”ã€‚ è®©æˆ‘ä»¬å–æ¶ˆé€è§†ä¸ªåˆ«æœˆä»½åˆ—ï¼Œä»¥è¿”å›æ¯ä½å‘˜å·¥æ¯æœˆçš„å•ä¸€é”€å”®å€¼ï¼š åˆ›å»ºå’Œæ’å…¥æ•°æ® 12345678910111213-- åˆ›å»º unpivoted_monthly_sales è¡¨CREATE TABLE unpivoted_monthly_sales( empid INT, jan INT, feb INT, mar INT, apr INT);-- æ’å…¥é”€å”®æ•°æ®INSERT INTO unpivoted_monthly_sales VALUES (1, 10400, 8000, 11000, 18000), (2, 39500, 90700, 12000, 5300); ä½¿ç”¨ UNPIVOT SELECT *FROM unpivoted_monthly_sales UNPIVOT (amount FOR month IN (jan, feb, mar, apr)); è¾“å‡ºï¼š 123456789101112+-------+-------+--------+| empid | month | amount |+-------+-------+--------+| 1 | jan | 10400 || 1 | feb | 8000 || 1 | mar | 11000 || 1 | apr | 18000 || 2 | jan | 39500 || 2 | feb | 90700 || 2 | mar | 12000 || 2 | apr | 5300 |+-------+-------+--------+ 2 è®¾è®¡å‚è€ƒï¼ˆç«å“åˆ†æï¼‰ 3 æ€è·¯ä¸å®ç° 3.1 æ€è·¯ å®ç° from + subquery è¾ƒä¸ºç®€å•ï¼Œåœ¨ TableReference::Subquery åŠ ä¸Š pivot å’Œ unpivot å­—æ®µï¼Œä¿®æ”¹ parser åŠå…¶ä»–ç›¸å…³åœ°æ–¹ã€‚ 123456789101112let subquery = map( rule! &#123; LATERAL? ~ &quot;(&quot; ~ #query ~ &quot;)&quot; ~ #table_alias? ~ #pivot? ~ #unpivot? &#125;, |(lateral, _, subquery, _, alias, pivot, unpivot)| TableReferenceElement::Subquery &#123; lateral: lateral.is_some(), subquery: Box::new(subquery), alias, pivot: pivot.map(Box::new), unpivot: unpivot.map(Box::new), &#125;,); å®ç° in + subquery ç›¸å¯¹å¤æ‚ï¼Œå› ä¸ºåœ¨ binder çš„æ—¶å€™å¿…é¡»çŸ¥é“ column çš„ name æ‰èƒ½ç”Ÿæˆé€»è¾‘è®¡åˆ’ï¼Œæ‰€ä»¥åªèƒ½å…ˆæ‰§è¡Œä¸€ä¸‹è¿™ä¸ª subquery ï¼Œç„¶åæŠŠè¿”å›å€¼å½“ä½œ values å¤„ç†ï¼›ä½†æ˜¯æ‰§è¡Œ query/plan æ˜¯åœ¨ service æ¨¡å—ä¸‹ï¼Œbinder æ˜¯åœ¨ sql æ¨¡å—ï¼Œå­˜åœ¨å¾ªç¯è°ƒç”¨çš„é—®é¢˜ã€‚â†’ è§£å†³å¾ªç¯ä¾èµ–é—®é¢˜ è§£å†³æ€è·¯æœ‰ä¸‰ç§ï¼š ã€æ€è·¯-1ã€‘åœ¨ pivot_rewrite é˜¶æ®µï¼ˆbinderï¼‰æ‰§è¡Œ Subquery å¾—åˆ°ç­”æ¡ˆï¼Œå‚è€ƒ QuerySampleExecutor å†™ä¸ªå›è°ƒå‡½æ•°åœ¨ binder é‡Œé¢è°ƒä¸€ä¸‹ service çš„å‡½æ•°æ‰§è¡Œã€‚ Pivot ç»“æ„ä½“æ–°æ·» Subquery å­—æ®µï¼ˆQueryï¼‰ï¼Œç”¨äºå­˜å‚¨ in + subquery ä¸­çš„ subqueryï¼› Pivot 123456789101112131415161718// åŸç‰ˆpub struct Pivot &#123; pub aggregate: Expr, pub value_column: Identifier, pub values: Vec&lt;Expr&gt;,&#125;// ä¿®æ”¹åpub enum PivotValues &#123; ColumnValues(Vec&lt;Expr&gt;), Subquery(Box&lt;Query&gt;),&#125;pub struct Pivot &#123; pub aggregate: Expr, pub value_column: Identifier, pub values: PivotValues,&#125; åœ¨ rewrite_pivot å‡½æ•°ä¸­å¯¹ Subquery è¿›è¡Œ parser + rewrite + opt + exec ç­‰æ“ä½œï¼Œå¹¶å°†ç»“æœå­˜åœ¨åŸæ¥çš„ values å­—æ®µï¼Œåç»­æ“ä½œä¸€è‡´ã€‚ æ‰§è¡Œ query çš„å›è°ƒå‡½æ•°ç›®å‰æœ‰åŸºäº PhysicalPlan çš„ï¼Œä¸€ç§æ–¹æ¡ˆæ˜¯åŸºäºè¯¥å‡½æ•°è¿›è¡Œæ“ä½œï¼›å¦ä¸€ç§æ–¹æ¡ˆæ˜¯æ–°æ·»åŸºäº Query String æ‰§è¡Œçš„å›è°ƒå‡½æ•°ã€‚ ã€æ€è·¯-2ã€‘åœ¨å‘ç° subquery çš„æ—¶å€™è¿”å›ï¼Œåœ¨ service é‡Œé¢æ‰§è¡Œä¹‹åé‡å†™ sqlï¼Œç„¶åå†æ¬¡æ‰§è¡Œã€‚ ã€æ€è·¯-3ã€‘ç°åœ¨çš„ plan_sql å‡½æ•°é‡Œé¢ä¼šæ‰§è¡Œ parser å¹¶ç”Ÿæˆ planï¼Œå¯ä»¥æŠŠè¿™ä¸ªå‡½æ•°æ‹†æˆä¸¤ä¸ªï¼š ç¬¬ä¸€ä¸ªå‡½æ•°æ‰§è¡Œ parserï¼Œç”Ÿæˆ stmtï¼ŒåŒæ—¶è¿›è¡Œä¸€äº› rewriteï¼Œå¦‚æœè¿™æ—¶å‘ç°æœ‰ subquery çš„è¯ï¼Œå°±å…ˆæ‰§è¡Œä¸€ä¸‹ï¼Œç„¶å rewriteã€‚ ç¬¬äºŒä¸ªå‡½æ•°ä¼ å…¥ rewrite ä¹‹åçš„ stmtï¼Œç”Ÿæˆ planã€‚ æœ¬ç€å°½å¯èƒ½å°‘çš„æ”¹åŠ¨å½“å‰ä»£ç ç»“æ„çš„åŸåˆ™ï¼Œé€‰æ‹©**ã€æ€è·¯-1ã€‘**è¿›è¡Œå®ç°ã€‚ 3.2 review ç›¸å…³ä¿®æ”¹ ã€review-1ã€‘é¿å…ä¸å¿…è¦çš„ clone 123456789101112131415161718192021// åŸç‰ˆlet value = columns[0].to_column(block.num_rows()); // ä¿®æ”¹for row in 0..block.num_rows() &#123; match columns[0].value.index(row).unwrap() &#123; ScalarRef::String(s) =&gt; &#123; let literal = Expr::Literal &#123; span, value: Literal::String(s.to_string()), &#125;; values.push(literal); &#125; _ =&gt; &#123; return Err(ErrorCode::SemanticError( &quot;The subquery of `pivot in` must return a string type&quot;, ) .set_span(span)); &#125; &#125;&#125; ã€review-2ã€‘é’ˆå¯¹äº subquery è¿”å›çš„æ¯ä¸ª String ä¸éœ€è¦è®¾ç½® spanï¼Œä½¿ç”¨ subquery çš„ span å³å¯ã€‚ ã€review-3ã€‘ä½¿ç”¨ block.num_columns() è®¡ç®— column çš„æ•°é‡ã€‚ // åŸç‰ˆlet columns = block.columns();if columns.len() != 1 &#123; // ...&#125;// ä¿®æ”¹åif block.num_columns() != 1 &#123; // ...&#125; ã€review-4ã€‘å°† sample_executor å’Œ subquery_executor åˆå¹¶æˆä¸€ä¸ª query_executorï¼Œå®ç°ä¸åŒçš„å‡½æ•°ç”¨æ¥åšåŒºåˆ†ã€‚ ã€review-5ã€‘å¯¹è¿”å›çš„ ErrorCode è®¾ç½® spanã€‚â†’ span ä¸ä½¿ç”¨ spanï¼š return Err(ErrorCode::SemanticError( &quot;The subquery of `pivot in` must return one column&quot;,)); MySQL [dev]&gt; SELECT * FROM (select * from monthly_sales) PIVOT(SUM(amount) FOR MONTH IN (select distinct month, month from monthly_sales)) ORDER BY EMPID;ERROR 1105 (HY000): SemanticError. Code: 1065, Text = The subquery of `pivot in` must return one column. ä½¿ç”¨ spanï¼š return Err(ErrorCode::SemanticError( &quot;The subquery of `pivot in` must return one column&quot;,).set_span(span)); MySQL [dev]&gt; SELECT * FROM (select * from monthly_sales) PIVOT(SUM(amount) FOR MONTH IN (select distinct empid from monthly_sales)) ORDER BY EMPID;ERROR 1105 (HY000): SemanticError. Code: 1065, Text = error: --&gt; SQL:1:78 |1 | SELECT * FROM (select * from monthly_sales) PIVOT(SUM(amount) FOR MONTH IN (select distinct empid from monthly_sales)) ORDER BY EMPID | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ The subquery of `pivot in` must return a string type. 3.3 bugs ã€bug-1ã€‘å› ä¸ºéœ€è¦ä¸¤æ¬¡ç”¨åˆ° pivot å˜é‡ï¼Œæ‰€ä»¥ä¼šæŠ¥ error: use of moved value çš„é”™è¯¯ã€‚â†’ error: use of moved value æŠŠ pivot å’Œ unpivot æŒªå‡ºå»ï¼Œæ”¹æˆä¸¤ä¸ªå•ç‹¬çš„å‡½æ•°ã€‚ ã€bug-2ã€‘rewrite_pivot æ˜¯é async å‡½æ•°ï¼Œä½†æ˜¯ subquery_executor.execute_query_with_sql_string æ˜¯ async å‡½æ•°ï¼Œrewrite_pivot ä¸­éœ€è¦è°ƒç”¨ subquery_executor.execute_query_with_sql_stringã€‚æ‰€ä»¥ä¼šæŠ¥é”™ï¼šawait is only allowed inside async functions and blocksã€‚â†’ åœ¨é async å‡½æ•°é‡Œè°ƒç”¨ async å‡½æ•° databend_common_base::runtime::block_on 4 æµ‹è¯• 4.1 åŠŸèƒ½æµ‹è¯• ä¸ snowflake è¯­æ³•ä¿æŒä¸€è‡´ï¼š pivot æ”¯æŒä¸‰ç§ subqueryï¼Œfrom + subqueryã€in + subqueryã€from + subquery + in + subqueryã€‚ unpivot åªæ”¯æŒ from + subquery ä¸€ç§ã€‚ 4.1.1 æ‰‹åŠ¨æµ‹è¯• æµ‹è¯• Pivot Create the monthly_sales table CREATE TABLE monthly_sales( empid INT, amount INT, month VARCHAR); Insert sales data 1234567891011121314151617INSERT INTO monthly_sales VALUES (1, 10000, &#x27;JAN&#x27;), (1, 400, &#x27;JAN&#x27;), (2, 4500, &#x27;JAN&#x27;), (2, 35000, &#x27;JAN&#x27;), (1, 5000, &#x27;FEB&#x27;), (1, 3000, &#x27;FEB&#x27;), (2, 200, &#x27;FEB&#x27;), (2, 90500, &#x27;FEB&#x27;), (1, 6000, &#x27;MAR&#x27;), (1, 5000, &#x27;MAR&#x27;), (2, 2500, &#x27;MAR&#x27;), (2, 9500, &#x27;MAR&#x27;), (1, 8000, &#x27;APR&#x27;), (1, 10000, &#x27;APR&#x27;), (2, 800, &#x27;APR&#x27;), (2, 4500, &#x27;APR&#x27;); Pivotï¼ˆåŸç‰ˆï¼‰ SELECT * FROM monthly_salesPIVOT(SUM(amount) FOR MONTH IN (&#x27;JAN&#x27;, &#x27;FEB&#x27;, &#x27;MAR&#x27;, &#x27;APR&#x27;))ORDER BY EMPID; from + subquery SELECT *FROM (select * from monthly_sales)PIVOT(SUM(amount) FOR MONTH IN (&#x27;JAN&#x27;, &#x27;FEB&#x27;, &#x27;MAR&#x27;, &#x27;APR&#x27;))ORDER BY EMPID; in + subquery SELECT * FROM monthly_salesPIVOT(SUM(amount) FOR MONTH IN (select distinct month from monthly_sales))ORDER BY EMPID; from + in + subquery SELECT * FROM (select * from monthly_sales)PIVOT(SUM(amount) FOR MONTH IN (select distinct month from monthly_sales))ORDER BY EMPID; Answer +-------+-------+-------+-------+-------+| empid | jan | feb | mar | apr |+-------+-------+-------+-------+-------+| 1 | 10400 | 8000 | 11000 | 18000 || 2 | 39500 | 90700 | 12000 | 5300 |+-------+-------+-------+-------+-------+ æµ‹è¯• Unpivot Create the unpivoted_monthly_sales table CREATE TABLE unpivoted_monthly_sales( empid INT, jan INT, feb INT, mar INT, apr INT); Insert sales data INSERT INTO unpivoted_monthly_sales VALUES (1, 10400, 8000, 11000, 18000), (2, 39500, 90700, 12000, 5300); unpivotï¼ˆåŸç‰ˆï¼‰ SELECT *FROM unpivoted_monthly_sales UNPIVOT (amount FOR month IN (jan, feb, mar, apr)); from + subquery SELECT * FROM (SELECT * FROM monthly_sales_1) UNPIVOT(sales FOR month IN (jan, feb, mar, april)) ORDER BY empid Answer 123456789101112+-------+-------+--------+| empid | month | amount |+-------+-------+--------+| 1 | jan | 10400 || 1 | feb | 8000 || 1 | mar | 11000 || 1 | apr | 18000 || 2 | jan | 39500 || 2 | feb | 90700 || 2 | mar | 12000 || 2 | apr | 5300 |+-------+-------+--------+ 4.1.2 å•å…ƒæµ‹è¯•ï¼ˆast ç›¸å…³ï¼‰ make unit-test parser æ”¹äº†ä¼šå¯¼è‡´ä¹‹å‰çš„æµ‹è¯•å¤±è´¥ï¼Œä¿®å¤ä¸‹é¢ä¸¤ä¸ªæ–‡ä»¶ï¼š src/query/ast/tests/it/testdata/stmt.txt src/query/ast/tests/it/testdata/query.txt å¦å¤–åœ¨ test_query å‡½æ•°åŠ ä¸Šä¸€ä¸ª pivot &amp; unpivot å¸¦ subquery çš„æµ‹è¯•ç”¨ä¾‹ï¼Œç›¸å…³æ–‡ä»¶ï¼šsrc/query/ast/tests/it/parser.rsã€‚ 4.1.3 é€»è¾‘æµ‹è¯•ï¼ˆsql æ‰§è¡Œç»“æœï¼‰ make sqllogic-test ä¸ºäº†åŠ å¿«æµ‹è¯•é€Ÿåº¦ï¼Œå¯ä»¥æŒ‡å®šç›®å½•è¿›è¡Œæ‰§è¡Œï¼Œç”šè‡³å¯ä»¥ä¿®æ”¹æ–‡ä»¶åä½¿å…¶åœ¨å½“å‰ç›®å½•å…ˆæ‰§è¡Œï¼š ./target/debug/databend-sqllogictests --handlers mysql --run_dir query æ·»åŠ  pivot &amp; unpivot ç›¸å…³ sql æŸ¥è¯¢ï¼Œç›¸å…³æ–‡ä»¶ï¼š tests/sqllogictests/suites/query/pivot.test tests/sqllogictests/suites/query/unpivot.test 4.2 æ€§èƒ½æµ‹è¯• 5 éš¾ç‚¹ 6 TODO X å‚è€ƒ https://docs.snowflake.com/en/sql-reference/constructs/pivot https://docs.snowflake.com/en/sql-reference/constructs/unpivot https://docs.databend.com/sql/sql-commands/query-syntax/query-pivot https://docs.databend.com/sql/sql-commands/query-syntax/query-unpivot","categories":[{"name":"DB","slug":"DB","permalink":"https://dragonliu2018.github.io/categories/DB/"},{"name":"Databend","slug":"DB/Databend","permalink":"https://dragonliu2018.github.io/categories/DB/Databend/"},{"name":"pr","slug":"DB/Databend/pr","permalink":"https://dragonliu2018.github.io/categories/DB/Databend/pr/"},{"name":"æ‰§è¡Œå™¨","slug":"DB/Databend/æ‰§è¡Œå™¨","permalink":"https://dragonliu2018.github.io/categories/DB/Databend/%E6%89%A7%E8%A1%8C%E5%99%A8/"},{"name":"è¡¨è¾¾å¼","slug":"DB/Databend/æ‰§è¡Œå™¨/è¡¨è¾¾å¼","permalink":"https://dragonliu2018.github.io/categories/DB/Databend/%E6%89%A7%E8%A1%8C%E5%99%A8/%E8%A1%A8%E8%BE%BE%E5%BC%8F/"},{"name":"æ‰§è¡Œå™¨","slug":"DB/æ‰§è¡Œå™¨","permalink":"https://dragonliu2018.github.io/categories/DB/%E6%89%A7%E8%A1%8C%E5%99%A8/"},{"name":"è¡¨è¾¾å¼","slug":"DB/æ‰§è¡Œå™¨/è¡¨è¾¾å¼","permalink":"https://dragonliu2018.github.io/categories/DB/%E6%89%A7%E8%A1%8C%E5%99%A8/%E8%A1%A8%E8%BE%BE%E5%BC%8F/"}],"tags":[{"name":"pr","slug":"pr","permalink":"https://dragonliu2018.github.io/tags/pr/"}]},{"title":"[Doris][pr] Implement format methods for Status","slug":"Doris-pr-Implement-format-methods-for-Status","date":"2025-09-14T09:26:44.000Z","updated":"2025-09-14T12:49:48.948Z","comments":true,"path":"2025/09/14/Doris-pr-Implement-format-methods-for-Status/","permalink":"https://dragonliu2018.github.io/2025/09/14/Doris-pr-Implement-format-methods-for-Status/","excerpt":"","text":"1 issue ä»‹ç» å½“å‰ Status ç±»å‹è¿›è¡Œ format æ—¶ï¼Œéœ€è¦è°ƒç”¨ to_string å‡½æ•°ï¼š fmt::format(&quot;&#123;&#125;&quot;, status.to_string()); æƒ³è¦çš„æ•ˆæœæ˜¯åªéœ€è¦ä¼ å…¥ Status ç±»å‹å³å¯ï¼š fmt::format(&quot;&#123;&#125;&quot;, status); 2 å®ç° 2.1 è§£æ fmt åº“æä¾›äº†ä¸€ä¸ªç±»æ¨¡æ¿ fmt::formatterï¼Œé€šè¿‡æ¨¡æ¿ç‰¹åŒ–ä¸º Status ç±»å‹æä¾›é€‚å½“çš„æ ¼å¼åŒ–æ–¹å¼ã€‚ ç„¶åå®ç° parse å’Œ format å‡½æ•°å³å¯ï¼š parse å‡½æ•°è´Ÿè´£è§£ææ ¼å¼å­—ç¬¦ä¸²ã€‚åœ¨é€šå¸¸æƒ…å†µä¸‹ï¼Œç”¨æˆ·å¯èƒ½ä¸éœ€è¦æä¾›è‡ªå·±çš„ parse å‡½æ•°ï¼Œè€Œå¯ä»¥ä½¿ç”¨ fmt é»˜è®¤æä¾›çš„ç‰ˆæœ¬ï¼Œè¯¥ç‰ˆæœ¬ç®€å•åœ°è¿”å›è§£æä¸Šä¸‹æ–‡çš„å¼€å§‹è¿­ä»£å™¨ã€‚ format å‡½æ•°æ˜¯ç”¨æˆ·å¿…é¡»æä¾›çš„å…³é”®æˆå‘˜å‡½æ•°ã€‚å®ƒå®šä¹‰äº†å¦‚ä½•å°†è‡ªå®šä¹‰ç±»å‹æ ¼å¼åŒ–ä¸ºå­—ç¬¦ä¸²ã€‚ 2.2 åŠŸèƒ½ä»£ç  ğŸ‘‰ **å‚è€ƒï¼š**https://wgml.pl/blog/formatting-user-defined-types-fmt.html 12345678910111213// specify formatter for Statustemplate &lt;&gt;struct fmt::formatter&lt;doris::Status&gt; &#123; template &lt;typename ParseContext&gt; constexpr auto parse(ParseContext&amp; ctx) &#123; return ctx.begin(); &#125; template &lt;typename FormatContext&gt; auto format(doris::Status const&amp; status, FormatContext&amp; ctx) &#123; return fmt::format_to(ctx.out(), &quot;&#123;&#125;&quot;, status.to_string()); &#125;&#125;; 2.3 æµ‹è¯•ä»£ç  å®ç°å®Œæˆåï¼Œç¼–å†™æµ‹è¯•æ ·ä¾‹ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„è¦†ç›–ç‡ã€‚ reviewer æå‡ºçš„å»ºè®®æ˜¯ï¼š please add 3 testsï¼š1. status == ok2. status == error &amp;&amp; has stacktrace3. status == error &amp;&amp; do not have stacktrace 3 é—®é¢˜ 3.1 ld: symbol(s) not found for architecture x86_64 åœ¨æœ¬åœ° macos ä¸Šå°è¯•å†™äº†ä¸ªæµ‹è¯•ç¨‹åºï¼Œä½†æ˜¯å‘ç”Ÿä¸‹é¢çš„æŠ¥é”™ï¼š âœ test-reset git:(main) âœ— g++ test.cpp -std=c++20 -o testUndefined symbols for architecture x86_64: &quot;void fmt::v10::detail::vformat_to&lt;char&gt;(fmt::v10::detail::buffer&lt;char&gt;&amp;, fmt::v10::basic_string_view&lt;char&gt;, fmt::v10::detail::vformat_args&lt;char&gt;::type, fmt::v10::detail::locale_ref)&quot;, referenced from: fmt::v10::appender fmt::v10::vformat_to&lt;fmt::v10::appender, 0&gt;(fmt::v10::appender, fmt::v10::basic_string_view&lt;char&gt;, fmt::v10::basic_format_args&lt;fmt::v10::basic_format_context&lt;fmt::v10::appender, char&gt; &gt;) in test-878b3f.o &quot;fmt::v10::detail::assert_fail(char const*, int, char const*)&quot;, referenced from: std::__1::make_unsigned&lt;long&gt;::type fmt::v10::detail::to_unsigned&lt;long&gt;(long) in test-878b3f.o &quot;fmt::v10::vprint(fmt::v10::basic_string_view&lt;char&gt;, fmt::v10::basic_format_args&lt;fmt::v10::basic_format_context&lt;fmt::v10::appender, char&gt; &gt;)&quot;, referenced from: _main in test-878b3f.old: symbol(s) not found for architecture x86_64clang: error: linker command failed with exit code 1 (use -v to see invocation) è§£å†³ï¼šåŸå› æ˜¯æœªé“¾æ¥ fmt åº“æ–‡ä»¶ g++ test.cpp -std=c++20 -o test -lfmt å‚è€ƒï¼šhttps://stackoverflow.com/questions/56608684/how-to-use-the-fmt-library-without-getting-undefined-symbols-for-architecture-x 3.2 fmt::formatter æ¨¡æ¿ç‰¹åŒ–ä»£ç ä¸èƒ½åœ¨ doris çš„ namespace å¼€å§‹å°†ç‰¹åŒ–ä»£ç æ”¾åœ¨äº† doris namespace ä¸­ï¼Œå‘ç”Ÿäº†ä¸‹é¢çš„æŠ¥é”™ï¼š Class template specialization of &#x27;formatter&#x27; not in a namespace enclosing &#x27;v8&#x27; is a Microsoft extension clang(-Wmicrosoft-template)[core.h(707, 8): ] Explicitly specialized declaration is here è§£å†³ï¼š namespace doris &#123;// doris code&#125; // end doris_namespace// define formatter here **å‚è€ƒï¼š**https://github.com/fmtlib/fmt/issues/2767","categories":[{"name":"Doris","slug":"Doris","permalink":"https://dragonliu2018.github.io/categories/Doris/"},{"name":"pr","slug":"Doris/pr","permalink":"https://dragonliu2018.github.io/categories/Doris/pr/"}],"tags":[{"name":"pr","slug":"pr","permalink":"https://dragonliu2018.github.io/tags/pr/"}]},{"title":"[Tool] Hexo ä½¿ç”¨æ•™ç¨‹","slug":"Tool-Hexo-ä½¿ç”¨æ•™ç¨‹","date":"2025-09-13T15:37:08.000Z","updated":"2025-09-14T16:48:24.062Z","comments":true,"path":"2025/09/13/Tool-Hexo-ä½¿ç”¨æ•™ç¨‹/","permalink":"https://dragonliu2018.github.io/2025/09/13/Tool-Hexo-%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/","excerpt":"","text":"ç¯å¢ƒå‡†å¤‡ âœ nvm --version0.39.1âœ node -vv24.8.0âœ npm -v11.6.0# å®‰è£… Hexonpm install -g hexo-cli æœ¬åœ°è¿è¡Œ Hexo åˆå§‹åŒ– hexoï¼Œç”Ÿæˆ hexo-blog ç›®å½• hexo init hexo-blog è¿›å…¥ hexo-blog ç›®å½•ï¼Œä¸‹è½½ pure ä¸»é¢˜å’Œ source æ–‡ç«  cd hexo-bloggit clone https://github.com/Dragonliu2018/hexo-theme-pure.git themes/puregit clone https://github.com/Dragonliu2018/hexo-source.git source é…ç½® pureï¼Œref link npm install hexo-wordcount --savenpm install hexo-generator-json-content --savenpm install hexo-generator-feed --savenpm install hexo-generator-sitemap --savenpm install hexo-generator-baidu-sitemap --savenpm install hexo-neat --savenpm install hexo-baidu-url-submit --savenpm install hexo-translate-title --savenpm un hexo-renderer-marked --savenpm i hexo-renderer-markdown-it-plus --save ä¿®æ”¹ _config.yml 1234567891011121314151617# é¡µé¢ä¸­åˆ†ç±»ç­‰å¯¼èˆªè¯çš„è¯­è¨€- language: en+ language: zh-CN# æœç´¢ç•Œé¢çš„åˆ†ç±»éƒ¨åˆ†æ‹¼æ¥ url- url: https://example.com+ url: https://dragonliu2018.github.io# è®¾ç½®ä¸»é¢˜- theme: + theme: pure# è®¾ç½®éƒ¨ç½²deploy: type: git repo: https://github.com/dragonliu2018/dragonliu2018.github.io.git branch: master è¿è¡Œ hexo hexo ghexo s éƒ¨ç½² Github å‚è€ƒï¼šhttps://hexo.io/docs/one-command-deployment å®‰è£… hexo-deployer-git npm install hexo-deployer-git --save ä¿®æ”¹é¡¹ç›®æ ¹ç›®å½• blog ä¸‹çš„ _config.yml deploy: type: git repo: https://github.com/dragonliu2018/dragonliu2018.github.io.git branch: master éƒ¨ç½² hexo g å¸¸ç”¨å‘½ä»¤ hexo cleanhexo ghexo shexo d","categories":[{"name":"Tool","slug":"Tool","permalink":"https://dragonliu2018.github.io/categories/Tool/"},{"name":"Hexo","slug":"Tool/Hexo","permalink":"https://dragonliu2018.github.io/categories/Tool/Hexo/"}],"tags":[]}],"categories":[{"name":"DB","slug":"DB","permalink":"https://dragonliu2018.github.io/categories/DB/"},{"name":"Databend","slug":"DB/Databend","permalink":"https://dragonliu2018.github.io/categories/DB/Databend/"},{"name":"pr","slug":"DB/Databend/pr","permalink":"https://dragonliu2018.github.io/categories/DB/Databend/pr/"},{"name":"æ‰§è¡Œå™¨","slug":"DB/Databend/æ‰§è¡Œå™¨","permalink":"https://dragonliu2018.github.io/categories/DB/Databend/%E6%89%A7%E8%A1%8C%E5%99%A8/"},{"name":"è¡¨è¾¾å¼","slug":"DB/Databend/æ‰§è¡Œå™¨/è¡¨è¾¾å¼","permalink":"https://dragonliu2018.github.io/categories/DB/Databend/%E6%89%A7%E8%A1%8C%E5%99%A8/%E8%A1%A8%E8%BE%BE%E5%BC%8F/"},{"name":"æ‰§è¡Œå™¨","slug":"DB/æ‰§è¡Œå™¨","permalink":"https://dragonliu2018.github.io/categories/DB/%E6%89%A7%E8%A1%8C%E5%99%A8/"},{"name":"è¡¨è¾¾å¼","slug":"DB/æ‰§è¡Œå™¨/è¡¨è¾¾å¼","permalink":"https://dragonliu2018.github.io/categories/DB/%E6%89%A7%E8%A1%8C%E5%99%A8/%E8%A1%A8%E8%BE%BE%E5%BC%8F/"},{"name":"Doris","slug":"Doris","permalink":"https://dragonliu2018.github.io/categories/Doris/"},{"name":"pr","slug":"Doris/pr","permalink":"https://dragonliu2018.github.io/categories/Doris/pr/"},{"name":"Tool","slug":"Tool","permalink":"https://dragonliu2018.github.io/categories/Tool/"},{"name":"Hexo","slug":"Tool/Hexo","permalink":"https://dragonliu2018.github.io/categories/Tool/Hexo/"}],"tags":[{"name":"pr","slug":"pr","permalink":"https://dragonliu2018.github.io/tags/pr/"}]}